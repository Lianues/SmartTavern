# SmartTavern å‰ç«¯ æ’ä»¶ä¸å·¥ä½œæµ å¼€å‘æŒ‡å—

æœ¬æ–‡é¢å‘å¸Œæœ›ä¸º SmartTavern å‰ç«¯å¢åŠ â€œæŒ‰é’®/æ˜¾ç¤ºé¢æ¿/å·¥ä½œæµåŠ¨ä½œâ€çš„ç¬¬ä¸‰æ–¹å¼€å‘è€…ï¼Œä»‹ç»è¿è¡Œæ—¶æ’ä»¶åè®®ã€Host APIã€äº‹ä»¶çº¦å®šã€UI æ’æ§½ä¸åŠ è½½ä¸å®‰å…¨ç­–ç•¥ã€‚

å‚è€ƒå®ç°ä¸æ ¸å¿ƒæ–‡ä»¶ï¼š
- è¿è¡Œæ—¶åŠ è½½å™¨ï¼š[PluginLoader](frontend_projects/SmartTavern/src/workflow/loader.js:1)
- å®¿ä¸» APIï¼š[Host](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
- å¼€å§‹é¡µæŒ‰é’® UIï¼š[HomeMenu.vue](frontend_projects/SmartTavern/src/components/home/HomeMenu.vue:1)
- è‡ªåŠ¨åŠ è½½å…¥å£ï¼š[main.js](frontend_projects/SmartTavern/src/main.js:1)
- å†…ç½®å¥‘çº¦ï¼ˆç±»å‹æç¤ºï¼‰ï¼š[contract.d.ts](frontend_projects/SmartTavern/src/workflow/slots/homeMenu/contract.d.ts:1)
- ç¤ºä¾‹æ’ä»¶ï¼ˆæœ€å°å¯è¿è¡Œï¼‰ï¼š[demo-home.js](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)
- Toast UI è¦†ç›–å±‚ï¼ˆæç¤ºå±•ç¤ºï¼‰ï¼š[ToastsOverlay.vue](frontend_projects/SmartTavern/src/components/common/ToastsOverlay.vue:1)

---

æ›´æ–°ï¼ˆ2025-10ï¼‰ï¼šåç«¯èµ„äº§è¯»å– + åŸç”Ÿç›¸å¯¹å¯¼å…¥ï¼ˆæ— éœ€ publicï¼‰
- æ–°å¢åç«¯èµ„äº§è¯»å– APIï¼ˆæ’ä»¶èµ„äº§ï¼‰ï¼š
  - å®ç°ï¼š[`python.get_plugins_asset_impl()`](api/modules/SmartTavern/data_catalog/impl.py:1116)
  - å¯¹å¤–æ³¨å†Œï¼š[`python.get_plugins_asset()`](api/modules/SmartTavern/data_catalog/data_catalog.py:990)
- å‰ç«¯å®¢æˆ·ç«¯æ”¯æŒï¼š
  - èµ„äº§è·å–ï¼š[`javascript.DataCatalog.getPluginsAsset()`](frontend_projects/SmartTavern/src/services/dataCatalog.js:232)
  - è½¬ Blobï¼š[`javascript.DataCatalog.getPluginsAssetBlob()`](frontend_projects/SmartTavern/src/services/dataCatalog.js:241)
- Loader èƒ½åŠ›æ‰©å±•ï¼š
  - åç«¯å…¥å£ JS ä¸­çš„ç›¸å¯¹å¯¼å…¥ï¼ˆå¦‚ `import './logo.png'` æˆ– `import('./logo.png')`ï¼‰å°†è¢« Loader è‡ªåŠ¨æ”¹å†™ä¸ºâ€œå¯¼å‡ºèµ„æº URL çš„ JS æ¨¡å—â€ï¼Œå¯ç›´æ¥ä½œä¸ºå­—ç¬¦ä¸²ä½¿ç”¨ï¼š
    - å…¥å£ï¼š[`javascript.loadBackendWorkflow()`](frontend_projects/SmartTavern/src/workflow/loader.js:212)
    - é `.js/.mjs/.cjs` æ‰©å±•åè§†ä¸ºèµ„äº§ï¼Œç”Ÿæˆ `export default 'blob:url'` çš„æ¨¡å—å¹¶æ›¿æ¢åŸç›¸å¯¹å¯¼å…¥ã€‚
- ä½¿ç”¨ç¤ºä¾‹ï¼š
  ```js
  // åç«¯æ’ä»¶å…¥å£ï¼ˆbackend_projects/.../my-plugin/index.jsï¼‰
  // é™æ€å¯¼å…¥å›¾ç‰‡ä¸º URL å­—ç¬¦ä¸²
  import logoUrl from './logo.png'
  export default function activate(host) {
    const img = new Image()
    img.src = logoUrl
    host.appendMessage?.({ role: 'system', content: `![Logo](${logoUrl})` })
    return () => {}
  }

  // åŠ¨æ€å¯¼å…¥å›¾ç‰‡
  const iconUrl = (await import('./icons/icon.webp')).default

  // JSON ä½œä¸ºèµ„äº§ï¼šè¿”å› URLï¼Œå†è‡ªè¡Œ fetch è§£æ
  const configUrl = (await import('./config.json')).default
  const cfg = await fetch(configUrl).then(r => r.json())
  ```
- è¾¹ç•Œä¸å®‰å…¨ï¼š
  - ä»…å…è®¸â€œåŒæ’ä»¶æ–‡ä»¶å¤¹å†…â€çš„ç›¸å¯¹å¯¼å…¥ï¼ˆ`./` æˆ– `../`ï¼‰ï¼Œè¶Šç•Œä¼šè¢«æ‹’ç»ã€‚
  - æ‰€æœ‰ç”Ÿæˆçš„ Blob URL åœ¨å¸è½½æ’ä»¶æ—¶ç»Ÿä¸€å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

## æ›´æ–°ï¼ˆ2025-10ï¼‰ï¼šç»Ÿä¸€åç«¯åœ°å€é…ç½®ï¼ˆVITE_API_BASE + è¿è¡Œæ—¶æŒä¹…åŒ–ï¼‰

- å•ä¸€ç¯å¢ƒå˜é‡ï¼šåœ¨ [filename](frontend_projects/SmartTavern/.env) ä¸­é…ç½® VITE_API_BASEï¼Œä½œä¸ºåç«¯ API åŸºå€ã€‚
- è¿è¡Œæ—¶ä¼˜å…ˆçº§ï¼šlocalStorage('st.backend_base') â†’ window.ST_BACKEND_BASE â†’ import.meta.env.VITE_API_BASE â†’ 'http://localhost:8050'ï¼ˆåˆå§‹åŒ–ä½ç½®ï¼š[filename](frontend_projects/SmartTavern/src/main.js)ï¼‰ã€‚
- å‰ç«¯æœåŠ¡ç»Ÿä¸€è¯»å–ï¼š
  - [filename](frontend_projects/SmartTavern/src/services/dataCatalog.js) ä¸ [filename](frontend_projects/SmartTavern/src/services/chatBranches.js)ï¼šåŸºäº ST_BACKEND_BASE æ‹¼æ¥ /api/modules/...
  - [filename](backend_projects/SmartTavern/plugins/prompt-router/prompt-router.js)ï¼šç»Ÿä¸€è§£æåç«¯åŸºå€ï¼ŒæŒ‰å‘½åç©ºé—´è°ƒç”¨ /api/workflow æˆ– /api/modulesã€‚
  - [filename](backend_projects/SmartTavern/plugins/example-backend-client/index.js)ï¼šä»¥ ST_BACKEND_BASE è®¿é—® /api/plugins/...ã€‚
  - ç®¡ç†é¢æ¿ [filename](frontend_projects/ProjectManager/js/api.js)ï¼šä»¥ ST_BACKEND_BASE ä½œä¸º baseURLï¼Œç»Ÿä¸€ /api å‰ç¼€ï¼›WebSocket èµ°åŒæº /wsã€‚
  - PromptEditor [filename](frontend_projects/PromptEditor/src/services/apiClient.ts)ï¼šä¼˜å…ˆ localStorage/window/envï¼›å¦åˆ™å›é€€ modularflow_config.py ç«¯å£æ¢æµ‹ã€‚
- UI å¯è§†åŒ–é…ç½®ï¼š
  - å¯åœ¨ [filename](frontend_projects/SmartTavern/src/components/home/OptionsView.vue) æˆ– [filename](frontend_projects/SmartTavern/src/components/sidebar/AppSettingsPanel.vue) ä¸­è®¾ç½®â€œåç«¯ API åœ°å€â€ï¼Œä¿å­˜åˆ° localStorage('st.backend_base') å¹¶åŒæ­¥ window.ST_BACKEND_BASEã€‚
- ä½¿ç”¨è§„èŒƒï¼š
  - è®¿é—®åç«¯ API æ—¶è¯·ä½¿ç”¨ ST_BACKEND_BASEï¼›ä»…åœ¨åŒæºé™æ€èµ„æºè§£æï¼ˆå¦‚å‰ç«¯æºç æ¨¡å—æˆ– public èµ„äº§ï¼‰æ—¶ä½¿ç”¨ window.location.originã€‚
- éƒ¨ç½²å»ºè®®ï¼š
  - ç”Ÿäº§/æœ¬åœ°ç»Ÿä¸€ç»´æŠ¤ [filename](frontend_projects/SmartTavern/.env) çš„ VITE_API_BASEï¼›ä¿®æ”¹åéœ€é‡å¯ Vite å¼€å‘æœåŠ¡å™¨ä»¥ç”Ÿæ•ˆæ„å»ºæœŸæ³¨å…¥ã€‚

## æ›´æ–°ï¼ˆ2025-10ï¼‰ï¼šåç«¯æ’ä»¶ APIï¼ˆPythonï¼‰/api/plugins å‘½åç©ºé—´

æ¦‚è¿°
- æ–°å¢æ”¯æŒåœ¨ä»“åº“æ ¹çš„ `api/plugins` ç›®å½•ä¸‹ä¸ºæ’ä»¶ç¼–å†™åç«¯ Python APIï¼Œè‡ªåŠ¨æš´éœ²ä¸º `/api/plugins/...` è·¯å¾„ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒè·¯ç”±å™¨æˆ–æ¨¡å—ç½‘å…³ã€‚
- å‘½åç©ºé—´è‡ªåŠ¨æ¨æ–­ï¼šå½“å‡½æ•°æ‰€å±æ¨¡å—ä»¥ `api.plugins` å¼€å¤´æ—¶ï¼Œæ³¨å†Œå™¨è‡ªåŠ¨è§£æä¸º `plugins` å‘½åç©ºé—´ï¼š[python.function(FunctionRegistry._derive_namespace)](core/api_registry.py:39)ã€‚
- æ³¨å†Œè£…é¥°å™¨ï¼šæ’ä»¶å…¥å£å‡½æ•°ä½¿ç”¨ç»Ÿä¸€è£…é¥°å™¨å®Œæˆæ³¨å†Œï¼š[python.function(register_api)](core/api_registry.py:148)ã€‚
- å¯åŠ¨å™¨æ‰©å±•ï¼šåç«¯å¯åŠ¨å™¨ä¼šé€’å½’å¯¼å…¥ `api/plugins`ï¼Œè§¦å‘æ’ä»¶å…¥å£çš„æ³¨å†Œé€»è¾‘ï¼š[python.function(load_all_api_modules)](start_all_apis.py:60)ã€‚
- å®¢æˆ·ç«¯è®¿é—®ï¼šç»Ÿä¸€å®¢æˆ·ç«¯æ”¯æŒ `plugins` å‘½åç©ºé—´ï¼ˆæœªæ˜¾å¼æŒ‡å®šæ—¶ï¼ŒæŒ‰ `modules â†’ workflow â†’ plugins` é¡ºåºå°è¯•ï¼‰ï¼š[python.function(ApiClient._paths_for)](core/api_client.py:62)ã€‚

ç›®å½•ä¸å‘½åè§„èŒƒ
- æ’ä»¶åç«¯ Python å…¥å£ç»Ÿä¸€å­˜æ”¾åœ¨ï¼š
  ```
  api/
  â””â”€ plugins/
     â””â”€ SmartTavern/
        â””â”€ <plugin_id>/
           â”œâ”€ __init__.py
           â””â”€ <plugin_id>.py   # å»ºè®®ï¼šå®ç°æ–‡ä»¶ä¸ç›®å½•åŒå
  ```
- å‡½æ•°è·¯å¾„çº¦å®šï¼ˆæ–œæ é£æ ¼ï¼‰ï¼š`path="SmartTavern/<plugin_id>/<action_name>"`ï¼Œæœ€ç»ˆå¯¹å¤–æš´éœ²ä¸º `/api/plugins/SmartTavern/<plugin_id>/<action_name>`ã€‚

æœ€å°ç¤ºä¾‹ï¼ˆå·²å†…ç½®ï¼‰
- æ–‡ä»¶ï¼š[`filename`](api/plugins/smarttavern/example_backend/example_backend.py)
- å¯¹å¤–è·¯ç”±ï¼š
  - GET/POST `/api/plugins/smarttavern/example_backend/echo`
  - GET/POST `/api/plugins/smarttavern/example_backend/info`

å‰ç«¯è°ƒç”¨ç¤ºä¾‹
- ç›´æ¥ HTTP è¯·æ±‚ï¼ˆæµè§ˆå™¨ç«¯æˆ–å‰ç«¯æœåŠ¡å†…ï¼‰ï¼š
  ```js
  // Echo ç¤ºä¾‹
  const res = await fetch('/api/plugins/smarttavern/example_backend/echo', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ text: 'hello' }),
  })
  const data = await res.json() // { echo: 'hello' }
  ```
- åœ¨ä½ çš„ JS æ’ä»¶ï¼ˆä½äº backend_projects/...ï¼‰ä¸­å¯ç›´æ¥è°ƒç”¨ä¸Šè¿°è·¯å¾„ï¼Œæˆ–å°è£…åˆ°ä½ çš„æœåŠ¡æ¨¡å—ä¸­ç»Ÿä¸€ä½¿ç”¨ã€‚

ä¸â€œåç«¯ JS å·¥ä½œæµâ€åä½œå…³ç³»
- æœ¬æ–‡ä¸»ä½“ä»‹ç»çš„æ˜¯â€œå‰ç«¯è¿è¡Œæ—¶ JS æ’ä»¶/å·¥ä½œæµâ€ä¸äº‹ä»¶é©±åŠ¨æ¶æ„ï¼›æ–°å¢çš„â€œåç«¯æ’ä»¶ APIï¼ˆPythonï¼‰â€ç”¨äºæä¾›åç«¯èƒ½åŠ›ï¼ˆå¦‚æ•°æ®å¤„ç†ã€å·¥å…·è°ƒç”¨ï¼‰ã€‚
- ä¸¤è€…åä½œæ–¹å¼ï¼šJS æ’ä»¶é€šè¿‡åŒæº HTTP è°ƒç”¨ `/api/plugins/...`ï¼Œå¹¶å°†ç»“æœä»¥æ¶ˆæ¯æˆ– UI å½¢å¼å›æ˜¾ï¼Œæˆ–åœ¨ Hooks ç­–ç•¥ä¸­ä½¿ç”¨ã€‚

è¯¦ç»†å¼€å‘æŒ‡å—ï¼ˆåç«¯ Python æ’ä»¶ï¼‰
- å®Œæ•´çš„â€œåç«¯æ’ä»¶ APIï¼ˆPythonï¼‰è§„èŒƒä¸ç¤ºä¾‹â€å·²æ”¶å½•åœ¨åç«¯æ–‡æ¡£ï¼š[filename](backend_projects/SmartTavern/plugins/README.md)
- æ¨èå…ˆé˜…è¯»åç«¯æ–‡æ¡£ä¸­çš„â€œæ ¸å¿ƒæœºåˆ¶/ç›®å½•ç»“æ„/æœ€å°ç¤ºä¾‹/è¿è¡Œä¸éªŒè¯â€ç« èŠ‚ï¼Œç„¶ååœ¨æœ¬å‰ç«¯æŒ‡å—ä¸­çš„äº‹ä»¶é€šé“ä¸ UI æ’æ§½ä¸­é›†æˆè°ƒç”¨ã€‚
## 1. ç›®æ ‡ä¸èŒƒå›´

- åœ¨ä¸ä¿®æ”¹åº”ç”¨ä¸»ä»£ç çš„æƒ…å†µä¸‹ï¼Œå…è®¸ä»¥â€œçº¯ JavaScript æ¨¡å—â€å½¢å¼æ‰©å±•å‰ç«¯èƒ½åŠ›
- åŠ¨æ€åŠ è½½/å¸è½½ï¼Œç«‹å³åæ˜ åˆ° UIï¼ˆä¾‹å¦‚å¼€å§‹é¡µæŒ‰é’®ï¼‰
- ç»Ÿä¸€äº‹ä»¶é©±åŠ¨æ¥å£ï¼Œæ”¯æŒè·¨æ¨¡å—åä½œï¼ˆäº‹ä»¶æ€»çº¿ + UI æ’æ§½ï¼‰
- é‡‡ç”¨ç™½åå•ä¸åŒæºé™åˆ¶ï¼Œæ§åˆ¶åŠ è½½æ¥æºçš„å®‰å…¨è¾¹ç•Œ

---

## 2. è¿è¡Œæ—¶æ’ä»¶åè®®

æ’ä»¶æ˜¯ä¸€ä¸ª ES Moduleï¼Œé»˜è®¤å¯¼å‡º activate(host) å‡½æ•°ï¼Œå¯é€‰è¿”å› dispose() æ¸…ç†å‡½æ•°ï¼š

- æ’ä»¶å…¥å£ï¼š[activate()](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)
- å®¿ä¸»å¯¹è±¡ï¼ˆç¨³å®š JS APIï¼‰ï¼š[Host](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
- è¿”å›æ¸…ç†å‡½æ•°ç”¨äºå¸è½½æ—¶æ’¤é”€äº‹ä»¶ç›‘å¬ã€ç§»é™¤å·²æ³¨å†Œ UI ç­‰ï¼Œé˜²æ­¢å†…å­˜ä¸çŠ¶æ€æ³„æ¼

å…¸å‹ç”Ÿå‘½å‘¨æœŸï¼š
1) åŠ è½½é˜¶æ®µï¼šç”±åŠ è½½å™¨ [PluginLoader.load()](frontend_projects/SmartTavern/src/workflow/loader.js:1) åŠ¨æ€ import æ’ä»¶å¹¶è°ƒç”¨å…¶ [activate()](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)
2) è¿è¡ŒæœŸï¼šæ’ä»¶é€šè¿‡ [Host.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)ã€[Host.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) ç­‰ API ä¸ç³»ç»Ÿäº¤äº’
3) å¸è½½é˜¶æ®µï¼šç”±åŠ è½½å™¨ [PluginLoader.unload()](frontend_projects/SmartTavern/src/workflow/loader.js:1) è°ƒç”¨æ’ä»¶è¿”å›çš„ dispose() åšèµ„æºæ¸…ç†

---

## 3. Host ç¨³å®š JS API

Host å¯¹å¤–æš´éœ²ç¨³å®šçš„ JS æ¥å£ï¼ˆå†…éƒ¨çŠ¶æ€ç”± Pinia æ‰¿è½½ï¼Œå·²å°è£…ï¼‰ï¼š

- åˆå§‹åŒ–ä¸å¯é€‰æš´éœ²åˆ° window
  - [Host.init()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - åˆå§‹åŒ–æ—¶å¯è®¾ç½® exposeToWindow=trueï¼Œä¾¿äºå¼€å‘æœŸåœ¨æ§åˆ¶å°é€šè¿‡ window.STHost è®¿é—®

- äº‹ä»¶æ€»çº¿ï¼ˆè½»é‡ Emitterï¼‰
  - [Host.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.events.once()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.events.off()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.events.clear()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.events.listenerCount()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)

- å¼€å§‹é¡µæŒ‰é’®ï¼ˆHomeMenu æ’æ§½ï¼‰
  - [Host.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.unregisterHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.listHomeButtons()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - å¥‘çº¦å­—æ®µè¯¦è§ [contract.d.ts](frontend_projects/SmartTavern/src/workflow/slots/homeMenu/contract.d.ts:1)

- å…¨å±€æ¶ˆæ¯ä¸æç¤º
  - [Host.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [Host.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)

- åªè¯»èšåˆçŠ¶æ€ï¼ˆä¸æ—§ä»£ç å…¼å®¹ï¼‰
  - [Host.state](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - åŒ…å« messagesã€toasts é˜Ÿåˆ—ä»¥åŠ slots.homeMenu

---

## 4. äº‹ä»¶çº¦å®šï¼ˆActionId å‘½åï¼‰

ä¸ºä¾¿äºåä½œä¸è¯­ä¹‰æ¸…æ™°ï¼Œå»ºè®®äº‹ä»¶æ ‡è¯†é‡‡ç”¨â€œåŸŸ.ä½ç½®.åŠ¨ä½œâ€çš„å‘½åçº¦å®šï¼š

- å¼€å§‹é¡µï¼ˆHomeï¼‰ï¼š`ui.home.*`
  - ä¾‹å¦‚ï¼š`ui.home.newGame` / `ui.home.openLoad` / `ui.home.openGallery` / `ui.home.openOptions`
- æ’ä»¶è‡ªå®šä¹‰ï¼šå…è®¸è‡ªå®šä¹‰ actionIdï¼ˆä¾‹å¦‚ `ui.home.demo`ï¼‰ï¼Œç”±æ’ä»¶è‡ªå·± [Host.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) ç»‘å®šå¹¶å¤„ç†

æŒ‰é’®ç‚¹å‡»æ´¾å‘å‚è€ƒï¼š
- UI ä¾§åœ¨ [HomeMenu.vue](frontend_projects/SmartTavern/src/components/home/HomeMenu.vue:1) å†…ä½¿ç”¨ [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) æ´¾å‘ `btn.actionId` + `btn.params`

---

## 5. UI æ’æ§½ï¼šå¼€å§‹é¡µæŒ‰é’®ï¼ˆHomeMenuï¼‰

- æ’æ§½å¥‘çº¦å®šä¹‰ï¼ˆç±»å‹æç¤ºï¼‰ï¼š[contract.d.ts](frontend_projects/SmartTavern/src/workflow/slots/homeMenu/contract.d.ts:1)
- æ¸²æŸ“å®ç°ï¼šå¼€å§‹é¡µå·¦ä¸‹çºµå‘èœå• [HomeMenu.vue](frontend_projects/SmartTavern/src/components/home/HomeMenu.vue:1)
- æ³¨å†Œ/æ’¤é”€ç”± Host å§”æ‰˜åˆ° Pinia Storeï¼Œå†…éƒ¨å®ç°ä½äºï¼š
  - [useHomeMenuStore()](frontend_projects/SmartTavern/src/stores/workflow/homeMenu.js:1)

æ’ä»¶ä¾§å¸¸ç”¨æ“ä½œï¼š
- æ³¨å†ŒæŒ‰é’®ï¼š[Host.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
- ç§»é™¤æŒ‰é’®ï¼š[Host.unregisterHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)

æŒ‰é’®æ¡ç›®å­—æ®µï¼ˆç®€è¦ï¼‰ï¼š
- idï¼ˆå¿…å¡«ï¼Œå”¯ä¸€ï¼‰
- labelï¼ˆå¿…å¡«ï¼Œå±•ç¤ºåç§°ï¼‰
- actionIdï¼ˆå¿…å¡«ï¼Œç‚¹å‡»åæ´¾å‘äº‹ä»¶ idï¼‰
- iconï¼ˆå¯é€‰ï¼Œlucide å›¾æ ‡åï¼‰
- orderï¼ˆå¯é€‰ï¼Œæ’åºå€¼ï¼Œæ•°å­—è¶Šå°è¶Šé ä¸Šï¼‰
- paramsï¼ˆå¯é€‰ï¼Œemit æ—¶é™„å¸¦çš„å‚æ•°ï¼‰
- tooltip / visibleWhen / disabledWhenï¼ˆå¯é€‰ï¼‰

---

## 6. æ¶ˆæ¯ä¸ Toast å±•ç¤º

- æ’ä»¶å¯é€šè¿‡ [Host.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) æ¨é€è½»é‡æç¤ºï¼ŒUI ç”± [ToastsOverlay.vue](frontend_projects/SmartTavern/src/components/common/ToastsOverlay.vue:1) è´Ÿè´£å±•ç¤ºã€‚ç±»å‹ï¼šinfo/success/warning/errorï¼Œæ”¯æŒè‡ªåŠ¨é”€æ¯ã€‚
- æ’ä»¶å¯é€šè¿‡ [Host.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) è¿½åŠ ä¸€æ¡æ¶ˆæ¯ï¼ˆç”¨äºè°ƒè¯•/å·¥ä½œæµå›æ˜¾ï¼‰ã€‚å†…éƒ¨çŠ¶æ€æ¥æºï¼š
  - [useMessagesStore()](frontend_projects/SmartTavern/src/stores/workflow/messages.js:1)
  - [useToastsStore()](frontend_projects/SmartTavern/src/stores/workflow/toasts.js:1)

---

## 7. æ’ä»¶æ”¾ç½®ä¸åŠ è½½

- æ¨èå°†ç¬¬ä¸‰æ–¹ JS æ’ä»¶æ”¾ç½®åœ¨å‰ç«¯é¡¹ç›®çš„ `/public/workflows/` ç›®å½•ï¼Œæ„å»ºæ—¶ä¼šåŸæ ·å¤åˆ¶ï¼Œè®¿é—®è·¯å¾„å³ä¸º `/workflows/xxx.js`
  - ç¤ºä¾‹ï¼š[demo-home.js](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)

- è¿è¡Œæ—¶åŠ è½½æ–¹å¼ï¼ˆä¸¤ç§ï¼‰ï¼š
  1) åº”ç”¨å†…è‡ªåŠ¨åŠ è½½ï¼ˆå·²åœ¨ [main.js](frontend_projects/SmartTavern/src/main.js:1) é›†æˆï¼‰
     - å¯åŠ¨æ—¶è°ƒç”¨ [PluginLoader.load()](frontend_projects/SmartTavern/src/workflow/loader.js:1) åŠ è½½ `/workflows/demo-home.js`
  2) æ§åˆ¶å°æ‰‹åŠ¨éªŒè¯
     - window.loader å·²åœ¨å¯åŠ¨æ—¶æŒ‚è½½ï¼ˆè§ [main.js](frontend_projects/SmartTavern/src/main.js:1)ï¼‰
     - åŠ è½½ï¼š`window.loader.load('/workflows/demo-home.js')`
     - å¸è½½ï¼š`window.loader.unload('wf_1')`ï¼ˆid ä»¥ load è¿”å›å€¼ä¸ºå‡†ï¼‰
     - åˆ—è¡¨ï¼š`window.loader.list()`

- æ³¨æ„ï¼ˆVite ä¸ /public èµ„æºï¼‰ï¼š
  - ä¸è¦ä»æºä»£ç ä¸­ç›´æ¥ import `/public` å†…çš„è„šæœ¬
  - é€šè¿‡ URL åŠ¨æ€ import å³å¯ï¼ŒåŠ è½½å™¨å·²ç»Ÿä¸€å¤„ç†æˆç»å¯¹ URLï¼ˆè§ [PluginLoader.load()](frontend_projects/SmartTavern/src/workflow/loader.js:1)ï¼‰

---

## 8. å®‰å…¨ï¼šç™½åå•ä¸åŒæºç­–ç•¥

åŠ è½½å™¨é»˜è®¤ç™½åå•ï¼ˆå¯é€šè¿‡ [PluginLoader.init()](frontend_projects/SmartTavern/src/workflow/loader.js:1) è¦†ç›–ï¼‰ï¼š
- `'same-origin'`ï¼šåŒæº
- `'/public/workflows/'`ã€`'/workflows/'`ï¼šå…è®¸ä»è¿™äº›è·¯å¾„å‰ç¼€åŠ è½½

ä½ å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªå®šä¹‰ï¼š
- [PluginLoader.init()](frontend_projects/SmartTavern/src/workflow/loader.js:1) æ¥æ”¶ `{ whitelist: string[] }`
- ç™½åå•é¡¹è§„åˆ™ï¼š
  - `'same-origin'`ï¼šä»…å…è®¸åŒæº
  - ä»¥ `'http'` å¼€å¤´ï¼šä½œä¸ºå®Œæ•´ URL å‰ç¼€åŒ¹é…
  - ä»¥ `'/'` å¼€å¤´ï¼šåŒ¹é…åŒæºä¸‹çš„ `pathname` å‰ç¼€

---

## 9. å¸è½½ä¸çƒ­æ›´æ–°

- å¸è½½ï¼š[PluginLoader.unload()](frontend_projects/SmartTavern/src/workflow/loader.js:1) ä¼šè°ƒç”¨æ’ä»¶çš„ dispose()ï¼Œæ’¤é”€äº‹ä»¶ä¸ UI
- æ‰¹é‡å¸è½½ï¼š[PluginLoader.unloadAll()](frontend_projects/SmartTavern/src/workflow/loader.js:1)
- å¼€å‘æœŸçƒ­è¿­ä»£å»ºè®®ï¼š
  - å…ˆå¸è½½æ—§ idï¼Œå†ä»¥ `replace:true` é‡æ–°åŠ è½½
  - æˆ–èµ‹äºˆå›ºå®š id å¹¶è®¾ç½® `replace:true`ï¼ŒåŠ è½½å™¨å°†è‡ªåŠ¨å…ˆå¸è½½ååŠ è½½

---

## 10. ç¤ºä¾‹æ’ä»¶è¯´æ˜ï¼ˆdemo-homeï¼‰

ç¤ºä¾‹ä½ç½®ï¼š[demo-home.js](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)

å…³é”®ç‚¹ï¼š
- é»˜è®¤å¯¼å‡º [activate()](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)ï¼›å†…éƒ¨ï¼š
  - æ³¨å†Œå¼€å§‹é¡µæŒ‰é’®ï¼š[host.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - ç›‘å¬ `ui.home.demo`ï¼š [host.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - ç‚¹å‡»å [host.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) ä¸ [host.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - è¿”å›æ¸…ç†å‡½æ•°ä»¥ä¾¿å¸è½½

---

## 11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

- Q: å¯¼å…¥ `/workflows/*.js` æŠ¥é”™ â€œThis file is in /public...â€  
  A: ä¸è¦ä½¿ç”¨æºç é™æ€ importï¼Œæ”¹ç”¨è¿è¡Œæ—¶ URL åŠ¨æ€åŠ è½½ã€‚åŠ è½½å™¨å†…éƒ¨å·²å°†ä¼ å…¥è·¯å¾„æ ‡å‡†åŒ–ä¸ºç»å¯¹ URLï¼ˆè§ [PluginLoader.load()](frontend_projects/SmartTavern/src/workflow/loader.js:1)ï¼‰ã€‚

- Q: ä¸ºä»€ä¹ˆæˆ‘è°ƒç”¨ [Host.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) æ²¡æœ‰çœ‹åˆ°æç¤ºï¼Ÿ  
  A: ç¡®è®¤åº”ç”¨å·²æŒ‚è½½ Toast UI è¦†ç›–å±‚ [ToastsOverlay.vue](frontend_projects/SmartTavern/src/components/common/ToastsOverlay.vue:1)ï¼ˆå·²åœ¨ [App.vue](frontend_projects/SmartTavern/src/App.vue:1) é›†æˆï¼‰ã€‚

- Q: æˆ‘å¦‚ä½•åœ¨ä¸»é¡µâ€œæŒ‰é’®ç‚¹å‡»â€ä¸­è§¦å‘è‡ªå®šä¹‰é€»è¾‘ï¼Ÿ  
  A: ä¸ºæŒ‰é’®è®¾ç½® `actionId`ï¼Œå¹¶ç”¨ [Host.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:1) è®¢é˜…è¯¥ idï¼›ç”¨æˆ·ç‚¹å‡»å [HomeMenu.vue](frontend_projects/SmartTavern/src/components/home/HomeMenu.vue:1) ä¼šè°ƒç”¨ [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)ã€‚

- Q: å¦‚ä½•å‘æ¶ˆæ¯é¢æ¿/å›æ˜¾åŒºè¿½åŠ å†…å®¹ï¼Ÿ  
  A: ä½¿ç”¨ [Host.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)ï¼›åœ¨æ§åˆ¶å°å¯é€šè¿‡ `window.STHost.state.messages` æ£€æŸ¥å½“å‰å¿«ç…§ã€‚

---

## 12. ç‰ˆæœ¬ä¸å…¼å®¹æ€§

- Host JS API å°½é‡ä¿æŒç¨³å®šï¼Œå†…éƒ¨å®ç°ï¼ˆPinia/ç»„ä»¶ç»“æ„ï¼‰å¯è°ƒæ•´ä½†ä¸å½±å“å¤–éƒ¨æ’ä»¶
- æ–°å¢ API ä¼šåœ¨æ–‡æ¡£ä¸æ³¨é‡Šä¸­è¯´æ˜ï¼›è‹¥å‘ç”Ÿç ´åæ€§å˜æ›´ï¼Œå°†åœ¨ release note ä¸­æ ‡æ³¨è¿ç§»æŒ‡å—

---

## 13. å¼€å‘è€…å¿«é€Ÿæ¸…å•

- å°†ä½ çš„æ’ä»¶ JS æ”¾åœ¨ `/public/workflows/your-plugin.js`
- åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
  - `window.loader.load('/workflows/your-plugin.js')`
- æ’ä»¶å†…éƒ¨ï¼š
  - å¯¼å‡º [activate(host)](frontend_projects/SmartTavern/public/workflows/demo-home.js:1)
  - å¯ç”¨ [host.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)ã€[host.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)ã€[host.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)ã€[host.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - è¿”å› dispose ä»¥æ¸…ç†æ³¨å†Œ/ç›‘å¬
- å¦‚éœ€å…è®¸è¿œç«¯åŠ è½½ï¼Œä½¿ç”¨ [PluginLoader.init()](frontend_projects/SmartTavern/src/workflow/loader.js:1) è‡ªå®šä¹‰ç™½åå•

---

è‹¥éœ€æ›´å¤æ‚çš„ UI æ‰©å±•ï¼ˆéå¼€å§‹é¡µæŒ‰é’®ï¼‰ï¼Œå¯åœ¨åç»­è¿­ä»£ä¸­å¼•å…¥æ›´å¤šâ€œæ’æ§½å¥‘çº¦â€ã€‚æ¬¢è¿åŸºäºå½“å‰äº‹ä»¶æ€»çº¿å…ˆè¡Œæ¢ç´¢åŸå‹å¹¶æäº¤å»ºè®®ã€‚

---

## 14. æ ‡å‡†äº‹ä»¶é€šé“ï¼šChat Channelsï¼ˆæ–°å»º/è¯»å–å¯¹è¯ï¼‰

ä¸ºè§£è€¦ UI ä¸å·¥ä½œæµï¼Œæä¾›â€œèŠå¤©å·¥ä½œæµæ ‡å‡†äº‹ä»¶é€šé“â€ï¼Œæ’ä»¶ä¸å†…éƒ¨æ¨¡å—é€šè¿‡äº‹ä»¶äº¤äº’ï¼Œæ— éœ€ç›´æ¥ä¾èµ–ç»„ä»¶ã€‚

- äº‹ä»¶å¸¸é‡å®šä¹‰ï¼š[chat.js](frontend_projects/SmartTavern/src/workflow/channels/chat.js)
- å®¿ä¸»äº‹ä»¶æ€»çº¿ï¼š[Host.events.on()/emit()/off()](frontend_projects/SmartTavern/src/workflow/core/host.js:58)

äº‹ä»¶æ¸…å•
- æ‰“å¼€æ¨¡æ€ï¼ˆä»… UI æ„å›¾ï¼‰
  - EVT_OPEN_NEW_CHAT = 'ui.modal.openNewChat'
  - EVT_OPEN_LOAD = 'ui.modal.openLoad'
- åˆ›å»ºå¯¹è¯ï¼ˆå·¥ä½œæµåŠ¨ä½œï¼‰
  - EVT_CHAT_CREATE_REQ   = 'workflow.chat.create.request'
  - EVT_CHAT_CREATE_OK    = 'workflow.chat.create.success'
  - EVT_CHAT_CREATE_FAIL  = 'workflow.chat.create.failure'
- åŠ è½½å¯¹è¯ï¼ˆå·¥ä½œæµåŠ¨ä½œï¼‰
  - EVT_CHAT_LOAD_REQ     = 'workflow.chat.load.request'
  - EVT_CHAT_LOAD_OK      = 'workflow.chat.load.success'
  - EVT_CHAT_LOAD_FAIL    = 'workflow.chat.load.failure'

åº”ç”¨å±‚æ¡¥æ¥
- åœ¨åº”ç”¨å…¥å£è§†å›¾ä¸­ç»Ÿä¸€è®¢é˜…äº‹ä»¶å¹¶æ¡¥æ¥è‡³æ—¢æœ‰ UI/æœåŠ¡é€»è¾‘ï¼ˆopenNewGameã€openHomeModal('load')ã€onLoadGameConfirm ç­‰ï¼‰ï¼š
  - è®¢é˜…/æ¸…ç†ä½ç½®ï¼š[App.vue](frontend_projects/SmartTavern/src/App.vue)
  - äº‹ä»¶æ¥æº/æ´¾å‘ï¼š[Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:61)

æ’ä»¶ä¾§ç”¨æ³•ç¤ºä¾‹
- æ‰“å¼€â€œæ–°å»ºå¯¹è¯â€æ¨¡æ€ï¼š
  - [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:61)('ui.modal.openNewChat')
- è¯·æ±‚ç›´æ¥åŠ è½½æŸä¸ªå­˜æ¡£ï¼š
  - [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:61)('workflow.chat.load.request', { file: '/data/conversations/222.json' })
  - æˆåŠŸ/å¤±è´¥å›æ‰§ï¼šç›‘å¬ 'workflow.chat.load.success' / 'workflow.chat.load.failure'
- è¯·æ±‚åˆ›å»ºæ–°å¯¹è¯ï¼ˆå½“å‰é»˜è®¤æ‰“å¼€æ¨¡æ€ï¼Œç”±ç”¨æˆ·ç¡®è®¤ï¼›åç»­å¯æ‰©å±•ç›´è¿åˆ›å»ºå‚æ•°ï¼‰ï¼š
  - [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:61)('workflow.chat.create.request', { type: 'threaded', meta: { ... } })
  - æˆåŠŸ/å¤±è´¥å›æ‰§ï¼šç›‘å¬ 'workflow.chat.create.success' / 'workflow.chat.create.failure'

ä¸ HomeMenu çš„å…³ç³»
- å¼€å§‹é¡µæŒ‰é’®ç‚¹å‡»åœ¨ [HomeMenu.vue](frontend_projects/SmartTavern/src/components/home/HomeMenu.vue:1) å†…é€šè¿‡ [Host.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:61) æ´¾å‘ actionId
- æ’ä»¶å¯ä»¥æ³¨å†ŒæŒ‰é’®ï¼ˆä¾‹å¦‚ actionId=ui.modal.openNewChat / workflow.chat.load.requestï¼‰ï¼Œæˆ–ç›´æ¥åœ¨é€»è¾‘ä¸­ emit æ ‡å‡†äº‹ä»¶ï¼Œæ— éœ€ UI ä¾èµ–

æ‰©å±•å»ºè®®
- è‹¥éœ€æ›´å¤šæ ‡å‡†é€šé“ï¼ˆä¾‹å¦‚æ¶ˆæ¯å‘é€ã€åˆ é™¤ã€åˆ†æ”¯åˆ‡æ¢ï¼‰ï¼Œå»ºè®®åœ¨ src/workflow/channels/ ä¸‹æŒ‰åŸŸåˆ’åˆ†æ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡æ¡£ä¸­è¡¥å……äº‹ä»¶è¡¨ä¸ç¤ºä¾‹

---

## 15. æ ‡å‡†äº‹ä»¶é€šé“ï¼šæ ¸å¿ƒèŠå¤©åŠŸèƒ½ï¼ˆMessages, Completion, Branchï¼‰

ä¸ºå®ç°å®Œå…¨äº‹ä»¶é©±åŠ¨çš„èŠå¤©åŠŸèƒ½ï¼Œå·²å»ºç«‹ä»¥ä¸‹æ ‡å‡†äº‹ä»¶é€šé“ï¼š

### 15.1 Messageé€šé“ï¼ˆæ¶ˆæ¯æ“ä½œï¼‰

**äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š[message.js](frontend_projects/SmartTavern/src/workflow/channels/message.js)
**æ¡¥æ¥å™¨**ï¼š[messageBridge.js](frontend_projects/SmartTavern/src/workflow/controllers/messageBridge.js)

**äº‹ä»¶æ¸…å•**ï¼š
- **æ¶ˆæ¯å‘é€**
  - `EVT_MESSAGE_SEND_REQ` = 'workflow.message.send.request'
  - `EVT_MESSAGE_SEND_OK` = 'workflow.message.send.success'
  - `EVT_MESSAGE_SEND_FAIL` = 'workflow.message.send.failure'
  
- **æ¶ˆæ¯ç¼–è¾‘**
  - `EVT_MESSAGE_EDIT_REQ` = 'workflow.message.edit.request'
  - `EVT_MESSAGE_EDIT_OK` = 'workflow.message.edit.success'
  - `EVT_MESSAGE_EDIT_FAIL` = 'workflow.message.edit.failure'

**æ’ä»¶ç”¨æ³•ç¤ºä¾‹**ï¼š
```javascript
// å‘é€ç”¨æˆ·æ¶ˆæ¯
Host.bus.emit('workflow.message.send.request', {
  conversationFile: '/data/conversations/222.json',
  role: 'user',
  content: 'Hello!',
  requestId: Date.now()
});

// ç›‘å¬å‘é€æˆåŠŸ
Host.bus.on('workflow.message.send.success', (payload) => {
  console.log('æ¶ˆæ¯å·²å‘é€:', payload.message);
});
```

### 15.2 Completioné€šé“ï¼ˆAIè¡¥å…¨ï¼‰

**äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š[completion.js](frontend_projects/SmartTavern/src/workflow/channels/completion.js)
**æ¡¥æ¥å™¨**ï¼š[completionBridge.js](frontend_projects/SmartTavern/src/workflow/controllers/completionBridge.js)

**äº‹ä»¶æ¸…å•**ï¼š
- **è¡¥å…¨è¯·æ±‚**
  - `EVT_COMPLETION_REQ` = 'workflow.completion.request'
  - `EVT_COMPLETION_START` = 'workflow.completion.start'
  - `EVT_COMPLETION_CHUNK` = 'workflow.completion.chunk'
  - `EVT_COMPLETION_DONE` = 'workflow.completion.done'
  - `EVT_COMPLETION_ERROR` = 'workflow.completion.error'

**æ’ä»¶ç”¨æ³•ç¤ºä¾‹**ï¼š
```javascript
// è¯·æ±‚AIè¡¥å…¨
Host.bus.emit('workflow.completion.request', {
  conversationFile: '/data/conversations/222.json',
  requestId: Date.now()
});

// ç›‘å¬æµå¼è¾“å‡º
Host.bus.on('workflow.completion.chunk', (payload) => {
  console.log('æ–°å†…å®¹ç‰‡æ®µ:', payload.chunk);
});

Host.bus.on('workflow.completion.done', (payload) => {
  console.log('è¡¥å…¨å®Œæˆ:', payload.fullText);
});
```

### 15.3 Branché€šé“ï¼ˆåˆ†æ”¯æ“ä½œï¼‰

**äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š[branch.js](frontend_projects/SmartTavern/src/workflow/channels/branch.js)
**æ¡¥æ¥å™¨**ï¼š[branchBridge.js](frontend_projects/SmartTavern/src/workflow/controllers/branchBridge.js)

**äº‹ä»¶æ¸…å•**ï¼š
- **åˆ†æ”¯è¡¨æŸ¥è¯¢**
  - `EVT_BRANCH_TABLE_REQ` = 'workflow.branch.table.request'
  - `EVT_BRANCH_TABLE_RES` = 'workflow.branch.table.response'

- **åˆ†æ”¯åˆ‡æ¢**
  - `EVT_BRANCH_SWITCH_REQ` = 'workflow.branch.switch.request'
  - `EVT_BRANCH_SWITCH_OK` = 'workflow.branch.switch.success'
  - `EVT_BRANCH_SWITCH_FAIL` = 'workflow.branch.switch.failure'

- **åˆ†æ”¯åˆ é™¤**
  - `EVT_BRANCH_DELETE_REQ` = 'workflow.branch.delete.request'
  - `EVT_BRANCH_DELETE_OK` = 'workflow.branch.delete.success'
  - `EVT_BRANCH_DELETE_FAIL` = 'workflow.branch.delete.failure'

- **åˆ†æ”¯é‡è¯•**ï¼ˆé‡æ–°ç”ŸæˆåŠ©æ‰‹å›å¤ï¼‰
  - `EVT_BRANCH_RETRY_REQ` = 'workflow.branch.retry.request'
  - `EVT_BRANCH_RETRY_OK` = 'workflow.branch.retry.success'
  - `EVT_BRANCH_RETRY_FAIL` = 'workflow.branch.retry.failure'

**æ’ä»¶ç”¨æ³•ç¤ºä¾‹**ï¼š
```javascript
// è¯·æ±‚åˆ†æ”¯è¡¨
Host.bus.emit('workflow.branch.table.request', {
  conversationFile: '/data/conversations/222.json',
  messageId: 'msg_123'
});

// åˆ‡æ¢åˆ°å…¶ä»–åˆ†æ”¯
Host.bus.emit('workflow.branch.switch.request', {
  conversationFile: '/data/conversations/222.json',
  messageId: 'msg_123',
  branchIndex: 1
});

// é‡è¯•ç”Ÿæˆï¼ˆåˆ›å»ºæ–°åˆ†æ”¯ï¼‰
Host.bus.emit('workflow.branch.retry.request', {
  conversationFile: '/data/conversations/222.json',
  messageId: 'msg_123'
});
```

---

## 16. æ ‡å‡†äº‹ä»¶é€šé“ï¼šæ•°æ®ç›®å½•ä¸è®¾ç½®ï¼ˆCatalog, Settingsï¼‰

ä¸ºå®ç° Sidebar é¢æ¿çš„äº‹ä»¶é©±åŠ¨ï¼Œå·²å»ºç«‹ä»¥ä¸‹æ•°æ®ç®¡ç†äº‹ä»¶é€šé“ï¼š

### 16.1 Catalogé€šé“ï¼ˆæ•°æ®ç›®å½•ï¼‰

**äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š[catalog.js](frontend_projects/SmartTavern/src/workflow/channels/catalog.js)
**æ¡¥æ¥å™¨**ï¼š[catalogBridge.js](frontend_projects/SmartTavern/src/workflow/controllers/catalogBridge.js)

**äº‹ä»¶æ¸…å•**ï¼š
- **è§’è‰²åˆ—è¡¨**
  - `EVT_CATALOG_CHARACTERS_REQ` = 'catalog:characters:req'
  - `EVT_CATALOG_CHARACTERS_RES` = 'catalog:characters:res'

- **äººè®¾åˆ—è¡¨**
  - `EVT_CATALOG_PERSONAS_REQ` = 'catalog:personas:req'
  - `EVT_CATALOG_PERSONAS_RES` = 'catalog:personas:res'

- **é¢„è®¾åˆ—è¡¨**
  - `EVT_CATALOG_PRESETS_REQ` = 'catalog:presets:req'
  - `EVT_CATALOG_PRESETS_RES` = 'catalog:presets:res'

- **ä¸–ç•Œä¹¦åˆ—è¡¨**
  - `EVT_CATALOG_WORLDBOOKS_REQ` = 'catalog:worldbooks:req'
  - `EVT_CATALOG_WORLDBOOKS_RES` = 'catalog:worldbooks:res'

- **æ­£åˆ™è§„åˆ™åˆ—è¡¨**
  - `EVT_CATALOG_REGEX_REQ` = 'catalog:regex:req'
  - `EVT_CATALOG_REGEX_RES` = 'catalog:regex:res'

- **LLMé…ç½®åˆ—è¡¨**
  - `EVT_CATALOG_LLMCONFIGS_REQ` = 'catalog:llmconfigs:req'
  - `EVT_CATALOG_LLMCONFIGS_RES` = 'catalog:llmconfigs:res'

**å“åº”å¼çŠ¶æ€**ï¼šCatalogé€šé“æä¾›å“åº”å¼ç¼“å­˜ï¼Œå¯ç›´æ¥åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š
- `CatalogChannel.characters` - è§’è‰²åˆ—è¡¨
- `CatalogChannel.personas` - äººè®¾åˆ—è¡¨
- `CatalogChannel.presets` - é¢„è®¾åˆ—è¡¨
- `CatalogChannel.worldbooks` - ä¸–ç•Œä¹¦åˆ—è¡¨
- `CatalogChannel.regexRules` - æ­£åˆ™è§„åˆ™åˆ—è¡¨
- `CatalogChannel.llmConfigs` - LLMé…ç½®åˆ—è¡¨
- `CatalogChannel.loadingStates` - åŠ è½½çŠ¶æ€æ˜ å°„
- `CatalogChannel.errorStates` - é”™è¯¯çŠ¶æ€æ˜ å°„

**æ’ä»¶ç”¨æ³•ç¤ºä¾‹**ï¼š
```javascript
// è¯·æ±‚è§’è‰²åˆ—è¡¨
Host.bus.emit('catalog:characters:req', { requestId: Date.now() });

// ç›‘å¬å“åº”
Host.bus.on('catalog:characters:res', (payload) => {
  if (payload.success) {
    console.log('è§’è‰²åˆ—è¡¨:', payload.items);
  }
});

// æˆ–ç›´æ¥è®¿é—®å“åº”å¼çŠ¶æ€ï¼ˆéœ€è¦åœ¨Vueç»„ä»¶ä¸­ï¼‰
import * as CatalogChannel from '@/workflow/channels/catalog';
console.log(CatalogChannel.characters.value);
```

### 16.2 Settingsé€šé“ï¼ˆè®¾ç½®ç®¡ç†ï¼‰

**äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š[settings.js](frontend_projects/SmartTavern/src/workflow/channels/settings.js)
**æ¡¥æ¥å™¨**ï¼š[settingsBridge.js](frontend_projects/SmartTavern/src/workflow/controllers/settingsBridge.js)

**äº‹ä»¶æ¸…å•**ï¼š
- **è·å–è®¾ç½®**
  - `EVT_SETTINGS_GET_REQ` = 'settings:get:req'
  - `EVT_SETTINGS_GET_RES` = 'settings:get:res'

- **æ›´æ–°è®¾ç½®**
  - `EVT_SETTINGS_UPDATE_REQ` = 'settings:update:req'
  - `EVT_SETTINGS_UPDATE_RES` = 'settings:update:res'

**å“åº”å¼çŠ¶æ€**ï¼šSettingsé€šé“æä¾›æŒ‰å¯¹è¯æ–‡ä»¶ç¼“å­˜çš„è®¾ç½®æ•°æ®ï¼š
- `SettingsChannel.settingsCache` - è®¾ç½®ç¼“å­˜ { [conversationFile]: settings }
- `SettingsChannel.loadingStates` - åŠ è½½çŠ¶æ€
- `SettingsChannel.errorStates` - é”™è¯¯çŠ¶æ€

**è¾…åŠ©å‡½æ•°**ï¼š
- `getSettings(conversationFile)` - è·å–æŒ‡å®šå¯¹è¯çš„è®¾ç½®
- `getSettingField(conversationFile, field)` - è·å–æŒ‡å®šå­—æ®µ
- `updateSettingsCache(conversationFile, settings)` - æ›´æ–°ç¼“å­˜
- `clearSettingsCache(conversationFile)` - æ¸…é™¤ç¼“å­˜
- `isLoading(conversationFile)` - æ£€æŸ¥åŠ è½½çŠ¶æ€
- `setError(conversationFile, error)` - è®¾ç½®é”™è¯¯

**æ’ä»¶ç”¨æ³•ç¤ºä¾‹**ï¼š
```javascript
// è·å–å¯¹è¯è®¾ç½®
Host.bus.emit('settings:get:req', {
  conversationFile: '/data/conversations/222.json',
  requestId: Date.now()
});

// ç›‘å¬å“åº”
Host.bus.on('settings:get:res', (payload) => {
  if (payload.success) {
    console.log('å½“å‰è®¾ç½®:', payload.settings);
  }
});

// æ›´æ–°è®¾ç½®
Host.bus.emit('settings:update:req', {
  conversationFile: '/data/conversations/222.json',
  patch: { character: 'xingyulu', preset: 'creative' },
  requestId: Date.now()
});

// ç›‘å¬æ›´æ–°ç»“æœ
Host.bus.on('settings:update:res', (payload) => {
  if (payload.success) {
    console.log('è®¾ç½®å·²æ›´æ–°');
  }
});
```

---

## 17. ç»„ä»¶äº‹ä»¶åŒ–è¿ç§»æŒ‡å—

### 17.1 è¿ç§»åŸåˆ™

**ä»ç›´æ¥æœåŠ¡è°ƒç”¨åˆ°äº‹ä»¶é©±åŠ¨**ï¼š
- âŒ æ—§æ–¹å¼ï¼šç»„ä»¶ç›´æ¥ `import` å¹¶è°ƒç”¨æœåŠ¡ï¼ˆå¦‚ `DataCatalog.listCharacters()`ï¼‰
- âœ… æ–°æ–¹å¼ï¼šç»„ä»¶å‘é€äº‹ä»¶è¯·æ±‚ï¼Œæ¡¥æ¥å™¨è°ƒç”¨æœåŠ¡å¹¶å¹¿æ’­å“åº”

**ä¼˜åŠ¿**ï¼š
1. **è§£è€¦**ï¼šç»„ä»¶ä¸æœåŠ¡è§£è€¦ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢
2. **å¯æ‰©å±•**ï¼šå·¥ä½œæµæ’ä»¶å¯ç›‘å¬/æ‹¦æˆª/å¢å¼ºä»»ä½•æ“ä½œ
3. **ç»Ÿä¸€**ï¼šæ‰€æœ‰æ•°æ®æµé€šè¿‡äº‹ä»¶æ€»çº¿ï¼Œæ˜“äºè¿½è¸ªå’Œè°ƒè¯•
4. **å“åº”å¼**ï¼šé€šé“æä¾›å“åº”å¼çŠ¶æ€ï¼Œå¤šç»„ä»¶å¯å…±äº«æ•°æ®

### 17.2 è¿ç§»æ­¥éª¤ç¤ºä¾‹

ä»¥ CharactersPanel ä¸ºä¾‹ï¼š

**æ—§ä»£ç **ï¼ˆç›´æ¥æœåŠ¡è°ƒç”¨ï¼‰ï¼š
```javascript
import DataCatalog from '@/services/dataCatalog'
import ChatBranches from '@/services/chatBranches'

async function loadData() {
  const listRes = await DataCatalog.listCharacters()
  const settingsRes = await ChatBranches.settings({ action: 'get', file: conversationFile })
  // å¤„ç†æ•°æ®...
}

async function onUse(key) {
  await ChatBranches.settings({
    action: 'update',
    file: conversationFile,
    patch: { character: key }
  })
}
```

**æ–°ä»£ç **ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ï¼š
```javascript
import Host from '@/workflow/core/host'
import * as CatalogChannel from '@/workflow/channels/catalog'
import * as SettingsChannel from '@/workflow/channels/settings'

// ä½¿ç”¨é€šé“æä¾›çš„å“åº”å¼çŠ¶æ€
const characters = CatalogChannel.characters
const loading = computed(() => CatalogChannel.loadingStates.value.characters)

function loadData() {
  // å‘é€è¯·æ±‚äº‹ä»¶
  Host.bus.emit(CatalogChannel.EVT_CATALOG_CHARACTERS_REQ, { requestId: Date.now() })
  Host.bus.emit(SettingsChannel.EVT_SETTINGS_GET_REQ, {
    conversationFile: props.conversationFile,
    requestId: Date.now()
  })
}

function onUse(key) {
  // å‘é€æ›´æ–°äº‹ä»¶
  Host.bus.emit(SettingsChannel.EVT_SETTINGS_UPDATE_REQ, {
    conversationFile: props.conversationFile,
    patch: { character: key },
    requestId: Date.now()
  })
}

// ç›‘å¬å“åº”ï¼ˆåœ¨ onMounted ä¸­ï¼‰
onMounted(() => {
  unsubscribe = Host.bus.on(CatalogChannel.EVT_CATALOG_CHARACTERS_RES, (payload) => {
    if (payload.success) {
      // æ•°æ®å·²è‡ªåŠ¨æ›´æ–°åˆ°å“åº”å¼çŠ¶æ€
    }
  })
})

onUnmounted(() => {
  if (unsubscribe) unsubscribe()
})
```

### 17.3 å·²è¿ç§»ç»„ä»¶æ¸…å•

ä»¥ä¸‹ç»„ä»¶å·²å®Œæˆäº‹ä»¶åŒ–è¿ç§»ï¼š

**èŠå¤©ç»„ä»¶**ï¼š
- [ThreadedChatPreview.vue](frontend_projects/SmartTavern/src/components/chat/ThreadedChatPreview.vue) - æ¶ˆæ¯å‘é€ã€åˆ†æ”¯åŠ è½½ã€é‡è¯•
- [MessageItem.vue](frontend_projects/SmartTavern/src/components/chat/MessageItem.vue) - æ¶ˆæ¯ç¼–è¾‘ã€åˆ†æ”¯åˆ‡æ¢ã€åˆ é™¤

**Sidebaré¢æ¿**ï¼š
- [CharactersPanel.vue](frontend_projects/SmartTavern/src/components/sidebar/CharactersPanel.vue) - è§’è‰²åˆ—è¡¨ä¸é€‰æ‹©
- [PersonaPanel.vue](frontend_projects/SmartTavern/src/components/sidebar/PersonaPanel.vue) - äººè®¾åˆ—è¡¨ä¸é€‰æ‹©
- [PresetsPanel.vue](frontend_projects/SmartTavern/src/components/sidebar/PresetsPanel.vue) - é¢„è®¾åˆ—è¡¨ä¸é€‰æ‹©
- [WorldbookPanel.vue](frontend_projects/SmartTavern/src/components/sidebar/WorldbookPanel.vue) - ä¸–ç•Œä¹¦å¤šé€‰
- [RegexPanel.vue](frontend_projects/SmartTavern/src/components/sidebar/RegexPanel.vue) - æ­£åˆ™è§„åˆ™å¤šé€‰
- [AIConfigPanel.vue](frontend_projects/SmartTavern/src/components/sidebar/AIConfigPanel.vue) - AIé…ç½®é€‰æ‹©

### 17.4 ç¼–æ’å·¥ä½œæµç¤ºä¾‹

äº‹ä»¶é©±åŠ¨æ¶æ„çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå¯ä»¥é€šè¿‡å·¥ä½œæµç¼–æ’å¤æ‚é€»è¾‘ã€‚

**ç¤ºä¾‹**ï¼š[default-thread-orchestrator.js](frontend_projects/SmartTavern/public/workflows/default-thread-orchestrator.js)

è¿™ä¸ªé»˜è®¤ç¼–æ’å™¨ç›‘å¬æ¶ˆæ¯å‘é€æˆåŠŸäº‹ä»¶ï¼Œç„¶åè‡ªåŠ¨ï¼š
1. åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å ä½
2. è§¦å‘AIè¡¥å…¨è¯·æ±‚
3. å¤„ç†è¡¥å…¨æµå¼è¾“å‡º
4. æ›´æ–°æ¶ˆæ¯å†…å®¹

```javascript
export default function activate(host) {
  // ç›‘å¬ç”¨æˆ·æ¶ˆæ¯å‘é€æˆåŠŸ
  const unsub1 = host.bus.on('workflow.message.send.success', async (payload) => {
    if (payload.message?.role === 'user') {
      // åˆ›å»ºåŠ©æ‰‹å ä½æ¶ˆæ¯
      host.bus.emit('workflow.message.send.request', {
        conversationFile: payload.conversationFile,
        role: 'assistant',
        content: '',
        isPlaceholder: true
      });
      
      // ç­‰å¾…å ä½åˆ›å»ºå®Œæˆåè§¦å‘è¡¥å…¨
      const unsub2 = host.bus.once('workflow.message.send.success', (pl) => {
        if (pl.message?.role === 'assistant') {
          host.bus.emit('workflow.completion.request', {
            conversationFile: payload.conversationFile
          });
        }
      });
    }
  });
  
  return () => { unsub1(); };
}
```

**å·¥ä½œæµå¯ä»¥å®ç°**ï¼š
- è‡ªåŠ¨ä¿å­˜è‰ç¨¿
- æ¶ˆæ¯é¢„å¤„ç†/åå¤„ç†
- è‡ªåŠ¨è§¦å‘ç›¸å…³æ“ä½œ
- è·¨ç»„ä»¶åè°ƒ
- å¢å¼ºç°æœ‰åŠŸèƒ½è€Œæ— éœ€ä¿®æ”¹ç»„ä»¶ä»£ç 

---

## 18. äº‹ä»¶é€šé“æœ€ä½³å®è·µ

### 18.1 å‘½åçº¦å®š

- **è¯·æ±‚äº‹ä»¶**ï¼š`<domain>.<entity>.<action>.request` æˆ– `<domain>:<entity>:req`
- **å“åº”äº‹ä»¶**ï¼š`.success` / `.failure` / `.response` æˆ– `:res`
- **è¿‡ç¨‹äº‹ä»¶**ï¼š`.start` / `.chunk` / `.progress`

### 18.2 äº‹ä»¶è´Ÿè½½ç»“æ„

**è¯·æ±‚è´Ÿè½½**åº”åŒ…å«ï¼š
- `requestId`: å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºå…³è”è¯·æ±‚ä¸å“åº”
- ä¸šåŠ¡å‚æ•°ï¼šå¦‚ `conversationFile`ã€`messageId` ç­‰

**å“åº”è´Ÿè½½**åº”åŒ…å«ï¼š
- `requestId`: ä¸è¯·æ±‚å¯¹åº”
- `success`: å¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸ/å¤±è´¥
- `error`: å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
- ä¸šåŠ¡æ•°æ®ï¼šå¦‚ `message`ã€`items`ã€`settings` ç­‰

### 18.3 ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å§‹ç»ˆæ¸…ç†ç›‘å¬å™¨**ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼š

```javascript
// Vueç»„ä»¶ä¸­
onMounted(() => {
  unsubscribe = Host.bus.on('some.event', handler);
});

onUnmounted(() => {
  if (unsubscribe) unsubscribe();
});

// æ’ä»¶ä¸­
export default function activate(host) {
  const unsub = host.bus.on('some.event', handler);
  return () => { unsub(); }; // disposeå‡½æ•°
}
```

### 18.4 ä¸€æ¬¡æ€§ç›‘å¬

å¯¹äºåªéœ€å“åº”ä¸€æ¬¡çš„åœºæ™¯ï¼Œä½¿ç”¨ `once` æˆ–æ‰‹åŠ¨æ¸…ç†ï¼š

```javascript
// æ–¹å¼1ï¼šä½¿ç”¨once
Host.bus.once('workflow.message.send.success', handler);

// æ–¹å¼2ï¼šæ‰‹åŠ¨æ¸…ç†
const unsub = Host.bus.on('workflow.message.send.success', (payload) => {
  handler(payload);
  unsub(); // ç«‹å³å–æ¶ˆè®¢é˜…
});
```

---

## 19. æ€»ç»“ä¸å±•æœ›

SmartTavern å‰ç«¯ç°å·²å»ºç«‹å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- æ’ä»¶ç³»ç»Ÿ + äº‹ä»¶æ€»çº¿ + æ ‡å‡†é€šé“ + å“åº”å¼çŠ¶æ€
- ç»„ä»¶ä¸æœåŠ¡å®Œå…¨è§£è€¦ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡
- æ”¯æŒè¿è¡Œæ—¶æ‰©å±•ã€å·¥ä½œæµç¼–æ’ã€çŠ¶æ€å…±äº«

**å·²æœ‰é€šé“**ï¼š
- Chatï¼ˆå¯¹è¯åˆ›å»º/åŠ è½½ï¼‰
- Messageï¼ˆæ¶ˆæ¯å‘é€/ç¼–è¾‘ï¼‰
- Completionï¼ˆAIè¡¥å…¨æµå¼è¾“å‡ºï¼‰
- Branchï¼ˆåˆ†æ”¯åˆ‡æ¢/åˆ é™¤/é‡è¯•ï¼‰
- Catalogï¼ˆæ•°æ®ç›®å½•æŸ¥è¯¢ï¼‰
- Settingsï¼ˆå¯¹è¯è®¾ç½®ç®¡ç†ï¼‰

**ä¸‹ä¸€æ­¥**ï¼š
- æ›´å¤šUIæ’æ§½ï¼ˆå¦‚è‡ªå®šä¹‰ä¾§è¾¹æ æ ‡ç­¾é¡µã€æ¶ˆæ¯é™„ä»¶æ¸²æŸ“å™¨ï¼‰
- æ›´å¤šäº‹ä»¶é€šé“ï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ã€ä¸»é¢˜åˆ‡æ¢ã€ç”¨æˆ·é…ç½®ï¼‰
- å·¥ä½œæµå¯è§†åŒ–ç¼–è¾‘å™¨
- è¿œç¨‹æ’ä»¶å¸‚åœº

æ¬¢è¿åŸºäºç°æœ‰æ¶æ„æ¢ç´¢æ›´å¤šå¯èƒ½æ€§ï¼Œå¹¶å‘ç¤¾åŒºè´¡çŒ®æ‚¨çš„æ’ä»¶å’Œå·¥ä½œæµï¼

---

## 20. EventSource æ ‡å‡†è§„èŒƒï¼šäº‹ä»¶æ¥æºè¿½è¸ª

ä¸ºäº†è®©å·¥ä½œæµæ’ä»¶èƒ½å¤ŸåŸºäºäº‹ä»¶æ¥æºåšæ›´ç²¾ç»†çš„å†³ç­–ï¼ŒSmartTavern å¼•å…¥äº† **EventSource** æ ‡å‡†è§„èŒƒã€‚æ‰€æœ‰äº‹ä»¶è´Ÿè½½éƒ½å¯ä»¥åŒ…å«å¯é€‰çš„ `source` å­—æ®µï¼Œç”¨äºæ ‡è¯†äº‹ä»¶çš„å‘èµ·æ–¹ã€ä¸Šä¸‹æ–‡ã€æ„å›¾ç­‰å…ƒä¿¡æ¯ã€‚

### 20.1 æ ¸å¿ƒæ¦‚å¿µ

**ç±»å‹å®šä¹‰**ï¼š[eventSource.d.ts](frontend_projects/SmartTavern/src/workflow/core/eventSource.d.ts)
**å·¥å…·å‡½æ•°**ï¼š[eventSource.js](frontend_projects/SmartTavern/src/workflow/core/eventSource.js)

EventSource æ¥å£å®šä¹‰ï¼š

```js
interface EventSource {
  componentId?: string        // ç»„ä»¶å®ä¾‹å”¯ä¸€æ ‡è¯†
  componentType?: string      // ç»„ä»¶ç±»å‹åç§°
  viewType?: string           // è§†å›¾ç±»å‹ï¼ˆthreaded/sandbox/startï¼‰
  intentType?: string         // æ“ä½œæ„å›¾ï¼ˆsend/retry/edit/deleteï¼‰
  userId?: string             // ç”¨æˆ·æ ‡è¯†ï¼ˆå¤šç”¨æˆ·åœºæ™¯ï¼‰
  sessionId?: string          // ä¼šè¯æ ‡è¯†
  workflowId?: string         // å·¥ä½œæµæ ‡è¯†
  priority?: 'high' | 'normal' | 'low'  // ä¼˜å…ˆçº§
  batchId?: string            // æ‰¹æ¬¡æ ‡è¯†
  parentEventId?: string      // çˆ¶çº§äº‹ä»¶ID
  metadata?: Record<string, any>  // æ‰©å±•å…ƒæ•°æ®
}
```

### 20.2 ä½¿ç”¨åœºæ™¯

**åœºæ™¯1ï¼šæ ¹æ®è§†å›¾ç±»å‹åº”ç”¨ä¸åŒç­–ç•¥**
```javascript
Host.bus.on('workflow.message.send.success', (payload) => {
  if (payload.source?.viewType === 'threaded') {
    // çº¿ç¨‹è§†å›¾çš„ç‰¹æ®Šå¤„ç†
  } else if (payload.source?.viewType === 'sandbox') {
    // æ²™ç›’è§†å›¾çš„ç‰¹æ®Šå¤„ç†
  }
})
```

**åœºæ™¯2ï¼šåŒºåˆ†ç”¨æˆ·ä¸»åŠ¨æ“ä½œå’Œè‡ªåŠ¨è§¦å‘**
```javascript
Host.bus.on('workflow.branch.switch.success', (payload) => {
  if (payload.source?.intentType === 'auto') {
    // è·³è¿‡é€šçŸ¥ï¼Œé™é»˜å¤„ç†
    return
  }
  // ç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢ï¼Œæ˜¾ç¤ºæç¤º
  host.pushToast({ message: 'å·²åˆ‡æ¢åˆ†æ”¯' })
})
```

**åœºæ™¯3ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—**
```javascript
Host.bus.on('workflow.completion.request', (payload) => {
  if (payload.source?.priority === 'high') {
    // è·³è¿‡é˜Ÿåˆ—ï¼Œç«‹å³å¤„ç†
  }
})
```

**åœºæ™¯4ï¼šæ‰¹é‡æ“ä½œè¿½è¸ª**
```javascript
const batchTracking = new Map()

Host.bus.on('catalog:characters:req', (payload) => {
  if (payload.source?.batchId) {
    // è¿½è¸ªæ‰¹æ¬¡è¿›åº¦
  }
})
```

### 20.3 è¾…åŠ©å·¥å…·

**åˆ›å»º EventSource**ï¼š
```javascript
import { createEventSource, ViewType, IntentType } from '@/workflow/core/eventSource'

const source = createEventSource('ThreadedChatPreview', {
  viewType: ViewType.THREADED,
  intentType: IntentType.SEND,
  priority: 'high'
})

Host.bus.emit('workflow.message.send.request', {
  conversationFile,
  content,
  source  // æ·»åŠ  source å­—æ®µ
})
```

**è¿‡æ»¤äº‹ä»¶æ¥æº**ï¼š
```javascript
import { matchesSource, isFromView, hasIntent } from '@/workflow/core/eventSource'

Host.bus.on('workflow.message.send.success', (payload) => {
  // æ–¹å¼1ï¼šä½¿ç”¨ matchesSource
  if (matchesSource(payload.source, { viewType: 'threaded', intentType: 'send' })) {
    // å¤„ç†åŒ¹é…çš„äº‹ä»¶
  }
  
  // æ–¹å¼2ï¼šä½¿ç”¨ä¾¿æ·å‡½æ•°
  if (isFromView(payload.source, ViewType.THREADED)) {
    // æ¥è‡ªçº¿ç¨‹è§†å›¾
  }
  
  if (hasIntent(payload.source, IntentType.RETRY)) {
    // é‡è¯•æ“ä½œ
  }
})
```

**è·å–å¯è¯»æ‘˜è¦**ï¼š
```javascript
import { summarizeSource } from '@/workflow/core/eventSource'

const summary = summarizeSource(payload.source)
console.log(`äº‹ä»¶æ¥æº: ${summary}`)  // 'ThreadedChatPreview @threaded [send]'
```

### 20.4 é¢„å®šä¹‰å¸¸é‡

**ViewType** - è§†å›¾ç±»å‹ï¼š
- `ViewType.THREADED` = 'threaded' - çº¿ç¨‹å¼å¯¹è¯è§†å›¾
- `ViewType.SANDBOX` = 'sandbox' - æ²™ç›’è§†å›¾
- `ViewType.START` = 'start' - å¼€å§‹é¡µ
- `ViewType.GALLERY` = 'gallery' - ç”»å»Šè§†å›¾

**IntentType** - æ“ä½œæ„å›¾ï¼š
- `IntentType.SEND` = 'send' - å‘é€æ“ä½œ
- `IntentType.RETRY` = 'retry' - é‡è¯•æ“ä½œ
- `IntentType.EDIT` = 'edit' - ç¼–è¾‘æ“ä½œ
- `IntentType.DELETE` = 'delete' - åˆ é™¤æ“ä½œ
- `IntentType.SWITCH` = 'switch' - åˆ‡æ¢æ“ä½œ
- `IntentType.CREATE` = 'create' - åˆ›å»ºæ“ä½œ
- `IntentType.LOAD` = 'load' - åŠ è½½æ“ä½œ
- `IntentType.BATCH` = 'batch' - æ‰¹é‡æ“ä½œ
- `IntentType.AUTO` = 'auto' - è‡ªåŠ¨è§¦å‘

**Priority** - ä¼˜å…ˆçº§ï¼š
- `Priority.HIGH` = 'high' - é«˜ä¼˜å…ˆçº§
- `Priority.NORMAL` = 'normal' - æ™®é€šä¼˜å…ˆçº§
- `Priority.LOW` = 'low' - ä½ä¼˜å…ˆçº§

### 20.5 ç»„ä»¶ä¾§ä½¿ç”¨ç¤ºä¾‹

åœ¨ Vue ç»„ä»¶ä¸­å‘é€å¸¦ source çš„äº‹ä»¶ï¼š

```javascript
import { createEventSource, ViewType, IntentType } from '@/workflow/core/eventSource'
import Host from '@/workflow/core/host'

export default {
  setup() {
    // åˆ›å»ºç»„ä»¶çº§åˆ«çš„ source
    const componentSource = createEventSource('ThreadedChatPreview', {
      viewType: ViewType.THREADED
    })
    
    function sendMessage(content) {
      Host.bus.emit('workflow.message.send.request', {
        conversationFile: props.conversationFile,
        content,
        source: {
          ...componentSource,
          intentType: IntentType.SEND,
          priority: 'normal'
        }
      })
    }
    
    function retryMessage(messageId) {
      Host.bus.emit('workflow.branch.retry.request', {
        conversationFile: props.conversationFile,
        messageId,
        source: {
          ...componentSource,
          intentType: IntentType.RETRY,
          priority: 'high'  // é‡è¯•ä¼˜å…ˆçº§é«˜
        }
      })
    }
    
    return { sendMessage, retryMessage }
  }
}
```

### 20.6 å·¥ä½œæµä¾§ä½¿ç”¨ç¤ºä¾‹

å®Œæ•´ç¤ºä¾‹ï¼š[demo-source-aware.js](frontend_projects/SmartTavern/public/workflows/demo-source-aware.js)

```javascript
export default function activate(host) {
  // ç­–ç•¥1ï¼šæ ¹æ®è§†å›¾ç±»å‹åº”ç”¨ä¸åŒå¢å¼º
  host.bus.on('workflow.message.send.success', (payload) => {
    if (payload.source?.viewType === 'threaded') {
      host.pushToast({ message: 'çº¿ç¨‹æ¶ˆæ¯å·²å‘é€' })
    } else if (payload.source?.viewType === 'sandbox') {
      host.pushToast({ message: 'ğŸ§ª æ²™ç›’æ¶ˆæ¯å·²å‘é€' })
    }
  })
  
  // ç­–ç•¥2ï¼šæ™ºèƒ½è¿‡æ»¤ - åªå¤„ç†ç”¨æˆ·ä¸»åŠ¨æ“ä½œ
  host.bus.on('workflow.branch.switch.success', (payload) => {
    if (payload.source?.intentType === 'auto') {
      return  // è·³è¿‡è‡ªåŠ¨åˆ‡æ¢çš„é€šçŸ¥
    }
    host.pushToast({ message: 'å·²åˆ‡æ¢åˆ†æ”¯' })
  })
  
  // ç­–ç•¥3ï¼šä¼˜å…ˆçº§è·¯ç”±
  host.bus.on('workflow.completion.request', (payload) => {
    if (payload.source?.priority === 'high') {
      console.log('é«˜ä¼˜å…ˆçº§è¯·æ±‚ï¼Œè·³è¿‡é˜Ÿåˆ—')
    }
  })
  
  // ç­–ç•¥4ï¼šæ‰¹é‡æ“ä½œåè°ƒ
  const batches = new Map()
  host.bus.on('catalog:characters:req', (payload) => {
    if (payload.source?.batchId) {
      if (!batches.has(payload.source.batchId)) {
        batches.set(payload.source.batchId, { count: 0, start: Date.now() })
      }
      batches.get(payload.source.batchId).count++
    }
  })
  
  // ç­–ç•¥5ï¼šè·¨ç»„ä»¶çŠ¶æ€è¿½è¸ª
  const componentStates = new Map()
  host.bus.on('*', (eventName, payload) => {
    if (payload?.source?.componentId) {
      if (!componentStates.has(payload.source.componentId)) {
        componentStates.set(payload.source.componentId, {
          type: payload.source.componentType,
          events: 0
        })
      }
      componentStates.get(payload.source.componentId).events++
    }
  })
}
```

### 20.7 æœ€ä½³å®è·µ

**1. å§‹ç»ˆæä¾› componentType å’Œ viewType**
```javascript
// âœ… æ¨è
const source = {
  componentType: 'ThreadedChatPreview',
  viewType: ViewType.THREADED,
  intentType: IntentType.SEND
}

// âŒ ä¸æ¨è
const source = {
  componentType: 'ThreadedChatPreview'
  // ç¼ºå°‘ viewType å’Œ intentType
}
```

**2. ä½¿ç”¨é¢„å®šä¹‰å¸¸é‡è€Œéå­—ç¬¦ä¸²å­—é¢é‡**
```javascript
// âœ… æ¨è
intentType: IntentType.RETRY

// âŒ ä¸æ¨è
intentType: 'retry'  // å®¹æ˜“æ‹¼å†™é”™è¯¯
```

**3. ä¸ºæ‰¹é‡æ“ä½œç”Ÿæˆå”¯ä¸€ batchId**
```javascript
const batchId = `batch_${Date.now()}`

items.forEach(item => {
  Host.bus.emit('some.event', {
    item,
    source: { batchId }
  })
})
```

**4. é‡ç”¨ componentSourceï¼ŒæŒ‰éœ€æ‰©å±•**
```javascript
const baseSource = createEventSource('MyComponent', {
  viewType: ViewType.THREADED
})

// å‘é€æ—¶æ‰©å±•
function sendMessage() {
  Host.bus.emit('event', {
    data,
    source: { ...baseSource, intentType: IntentType.SEND }
  })
}

function retryMessage() {
  Host.bus.emit('event', {
    data,
    source: { ...baseSource, intentType: IntentType.RETRY, priority: 'high' }
  })
}
```

**5. åœ¨å·¥ä½œæµä¸­ä¼˜é›…åœ°å¤„ç†ç¼ºå¤±çš„ source**
```javascript
Host.bus.on('some.event', (payload) => {
  // ä½¿ç”¨å¯é€‰é“¾å’Œé»˜è®¤å€¼
  const viewType = payload.source?.viewType ?? 'unknown'
  const priority = payload.source?.priority ?? 'normal'
  
  // æˆ–ä½¿ç”¨è¾…åŠ©å‡½æ•°å®‰å…¨æ£€æŸ¥
  if (matchesSource(payload.source, { viewType: 'threaded' })) {
    // åªåœ¨ source å­˜åœ¨ä¸”åŒ¹é…æ—¶æ‰§è¡Œ
  }
})
```

### 20.8 å‘åå…¼å®¹

EventSource æ˜¯**å¯é€‰å­—æ®µ**ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œï¼š

- âœ… ä¸åŒ…å« `source` çš„äº‹ä»¶ä»ç„¶å¯ä»¥æ­£å¸¸æ´¾å‘å’Œç›‘å¬
- âœ… å·¥ä½œæµå¯ä»¥é€šè¿‡å¯é€‰é“¾ `payload.source?.xxx` å®‰å…¨è®¿é—®
- âœ… è¾…åŠ©å‡½æ•°å¯¹ `undefined` source æä¾›å®‰å…¨çš„å›é€€è¡Œä¸º

æ–°ç»„ä»¶**å»ºè®®**æ·»åŠ  source æ”¯æŒï¼Œä»¥è·å¾—æ›´å¼ºå¤§çš„å·¥ä½œæµèƒ½åŠ›ã€‚

### 20.9 è°ƒè¯•æŠ€å·§

**åœ¨æ§åˆ¶å°æŸ¥çœ‹æ‰€æœ‰äº‹ä»¶çš„æ¥æº**ï¼š
```javascript
window.STHost.bus.on('*', (eventName, payload) => {
  if (payload?.source) {
    console.log(`[${eventName}] æ¥æº:`, summarizeSource(payload.source))
  }
})
```

**ç»Ÿè®¡ä¸åŒæ¥æºçš„äº‹ä»¶åˆ†å¸ƒ**ï¼š
```javascript
const stats = { byView: {}, byIntent: {}, total: 0 }

window.STHost.bus.on('workflow.message.send.success', (payload) => {
  stats.total++
  if (payload.source?.viewType) {
    stats.byView[payload.source.viewType] =
      (stats.byView[payload.source.viewType] || 0) + 1
  }
  if (payload.source?.intentType) {
    stats.byIntent[payload.source.intentType] =
      (stats.byIntent[payload.source.intentType] || 0) + 1
  }
})

// æŸ¥çœ‹ç»Ÿè®¡
console.table(stats.byView)
console.table(stats.byIntent)
```

---

## 21. äº‹ä»¶é€šé“ source å­—æ®µè§„èŒƒ

æ‰€æœ‰æ ‡å‡†äº‹ä»¶é€šé“çš„è¯·æ±‚å’Œå“åº”è´Ÿè½½éƒ½**å»ºè®®**åŒ…å« `source` å­—æ®µï¼š

### 21.1 Message é€šé“

```javascript
// è¯·æ±‚
Host.bus.emit('workflow.message.send.request', {
  conversationFile,
  nodeId,
  role,
  content,
  tag,
  source: {  // å¯é€‰ä½†æ¨è
    componentType: 'ThreadedChatPreview',
    viewType: ViewType.THREADED,
    intentType: IntentType.SEND
  }
})

// å“åº”ä¼šåŸæ ·è¿”å› source
Host.bus.on('workflow.message.send.success', (payload) => {
  console.log('æ¥æº:', payload.source)
})
```

### 21.2 Completion é€šé“

```javascript
Host.bus.emit('workflow.completion.request', {
  conversationFile,
  llmConfigFile,
  tag,
  source: {
    componentType: 'ThreadedChatPreview',
    viewType: ViewType.THREADED,
    priority: 'high'  // å¯ç”¨äºä¼˜å…ˆçº§é˜Ÿåˆ—
  }
})
```

### 21.3 Branch é€šé“

```javascript
Host.bus.emit('workflow.branch.retry.request', {
  conversationFile,
  retryNodeId,
  tag,
  source: {
    componentType: 'MessageItem',
    intentType: IntentType.RETRY,
    priority: 'high'
  }
})
```

### 21.4 Catalog é€šé“

```javascript
Host.bus.emit('catalog:characters:req', {
  requestId,
  source: {
    componentType: 'CharactersPanel',
    batchId: 'batch_123'  // æ‰¹é‡åŠ è½½æ—¶ä½¿ç”¨
  }
})
```

### 21.5 Settings é€šé“

```javascript
Host.bus.emit('settings:update:req', {
  conversationFile,
  patch,
  source: {
    componentType: 'CharactersPanel',
    intentType: IntentType.AUTO  // æ ‡è®°ä¸ºè‡ªåŠ¨æ›´æ–°
  }
})
```

---

## 22. æ€»ç»“ä¸å±•æœ›ï¼ˆæ›´æ–°ï¼‰

SmartTavern å‰ç«¯ç°å·²å»ºç«‹å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- æ’ä»¶ç³»ç»Ÿ + äº‹ä»¶æ€»çº¿ + æ ‡å‡†é€šé“ + å“åº”å¼çŠ¶æ€
- ç»„ä»¶ä¸æœåŠ¡å®Œå…¨è§£è€¦ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡
- æ”¯æŒè¿è¡Œæ—¶æ‰©å±•ã€å·¥ä½œæµç¼–æ’ã€çŠ¶æ€å…±äº«
- **EventSource æ ‡å‡†è§„èŒƒ**ï¼šäº‹ä»¶æ¥æºè¿½è¸ªä¸æ™ºèƒ½å†³ç­–

**å·²æœ‰é€šé“**ï¼š
- Chatï¼ˆå¯¹è¯åˆ›å»º/åŠ è½½ï¼‰
- Messageï¼ˆæ¶ˆæ¯å‘é€/ç¼–è¾‘ï¼‰+ EventSource æ”¯æŒ
- Completionï¼ˆAIè¡¥å…¨æµå¼è¾“å‡ºï¼‰+ EventSource æ”¯æŒ
- Branchï¼ˆåˆ†æ”¯åˆ‡æ¢/åˆ é™¤/é‡è¯•ï¼‰+ EventSource æ”¯æŒ
- Catalogï¼ˆæ•°æ®ç›®å½•æŸ¥è¯¢ï¼‰+ EventSource æ”¯æŒ
- Settingsï¼ˆå¯¹è¯è®¾ç½®ç®¡ç†ï¼‰+ EventSource æ”¯æŒ

**EventSource èƒ½åŠ›**ï¼š
- ğŸ¯ æ ¹æ®è§†å›¾ç±»å‹åº”ç”¨ä¸åŒç­–ç•¥
- ğŸ¯ åŒºåˆ†ç”¨æˆ·ä¸»åŠ¨æ“ä½œå’Œè‡ªåŠ¨è§¦å‘
- ğŸ¯ å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œæ™ºèƒ½è·¯ç”±
- ğŸ¯ è¿½è¸ªæ‰¹é‡æ“ä½œè¿›åº¦
- ğŸ¯ è·¨ç»„ä»¶çŠ¶æ€åè°ƒ
- ğŸ¯ æ”¶é›†è¯¦ç»†çš„æ“ä½œæ¥æºåˆ†ææ•°æ®

**ä¸‹ä¸€æ­¥**ï¼š
- æ›´å¤šUIæ’æ§½ï¼ˆå¦‚è‡ªå®šä¹‰ä¾§è¾¹æ æ ‡ç­¾é¡µã€æ¶ˆæ¯é™„ä»¶æ¸²æŸ“å™¨ï¼‰
- æ›´å¤šäº‹ä»¶é€šé“ï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ã€ä¸»é¢˜åˆ‡æ¢ã€ç”¨æˆ·é…ç½®ï¼‰
- å·¥ä½œæµå¯è§†åŒ–ç¼–è¾‘å™¨
- è¿œç¨‹æ’ä»¶å¸‚åœº
- EventSource åˆ†æä»ªè¡¨æ¿

æ¬¢è¿åŸºäºç°æœ‰æ¶æ„æ¢ç´¢æ›´å¤šå¯èƒ½æ€§ï¼Œå¹¶å‘ç¤¾åŒºè´¡çŒ®æ‚¨çš„æ’ä»¶å’Œå·¥ä½œæµï¼

## 23. åç«¯å·¥ä½œæµè‡ªåŒ…å«ï¼šæ¶ˆæ¯è½¬å‘æ’ä»¶ä¸é…ç½®

ç›®æ ‡
- é€šè¿‡çº¯å·¥ä½œæµ/æ’ä»¶è„šæœ¬æ‰©å±•åŠŸèƒ½ï¼Œæ— éœ€ä¿®æ”¹åº”ç”¨ä¸»å…¥å£ï¼ˆå¦‚ [main.js](frontend_projects/SmartTavern/src/main.js)ï¼‰
- å·¥ä½œæµåœ¨å‰ç«¯å¯åŠ¨åè‡ªåŠ¨ä»åç«¯æ‹‰å–å¹¶åŠ è½½ï¼ˆåç«¯ä¼˜å…ˆï¼Œæ”¯æŒåŒåè¦†ç›–ï¼‰

æ–‡ä»¶ä¸ä½ç½®
- æ’ä»¶ï¼šæ¶ˆæ¯è½¬å‘åˆ°å¤–éƒ¨æœåŠ¡å™¨
  - [message-forwarder.js](backend_projects/SmartTavern/plugins/message-forwarder.js)
- é…ç½®å…¥å£ï¼šåœ¨å¼€å§‹é¡µæä¾›â€œForwarder é…ç½®â€æŒ‰é’®
  - [message-forwarder-config.js](backend_projects/SmartTavern/plugins/message-forwarder-config.js)

äº‹ä»¶é€šé“ä¸æ¡¥æ¥
- ç›‘å¬ç”¨æˆ·æ¶ˆæ¯å‘é€è¯·æ±‚å¹¶è½¬å‘ï¼š
  - [message.js.EVT_MESSAGE_SEND_REQ](frontend_projects/SmartTavern/src/workflow/channels/message.js:80)
- è¯»å–/æ›´æ–°å¯¹è¯è®¾ç½®ï¼ˆæ’ä»¶é…ç½®å­˜æ”¾åœ¨ settings.plugins.messageForwarderï¼‰ï¼š
  - è¯»å–å­—æ®µï¼š[settings.js.getSettingField()](frontend_projects/SmartTavern/src/workflow/channels/settings.js:58)
  - å‘èµ·æ›´æ–°è¯·æ±‚äº‹ä»¶ï¼š[settings.js.EVT_SETTINGS_UPDATE_REQ](frontend_projects/SmartTavern/src/workflow/channels/settings.js:19)
  - è®¾ç½®æ¡¥æ¥å™¨åˆå§‹åŒ–ï¼š[settingsBridge.js.initSettingsBridge()](frontend_projects/SmartTavern/src/workflow/controllers/settingsBridge.js:15)

å®¿ä¸» API ä½¿ç”¨
- è¿½åŠ æ¶ˆæ¯å›æ˜¾ï¼š[host.js.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:52)
- æ¨é€æç¤º Toastï¼š[host.js.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:56)
- æ³¨å†Œå¼€å§‹é¡µæŒ‰é’®ï¼ˆåœ¨é…ç½®å…¥å£ä¸­ä½¿ç”¨ï¼‰ï¼š[host.js.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:25)
- äº‹ä»¶æ€»çº¿ï¼ˆç›‘å¬/æ´¾å‘ï¼‰ï¼š[host.js.events.on()](frontend_projects/SmartTavern/src/workflow/core/host.js:74)ã€[host.js.events.emit()](frontend_projects/SmartTavern/src/workflow/core/host.js:77)

å·¥ä½œæµåŠ è½½ï¼ˆåç«¯ä¼˜å…ˆï¼‰
- åŠ è½½å™¨åˆå§‹åŒ–ä¸ç™½åå•ï¼š
  - [loader.js.init()](frontend_projects/SmartTavern/src/workflow/loader.js:59) å¯è‡ªå®šä¹‰ç™½åå•æ¥æº
- åŠ¨æ€åŠ è½½ä¸å¸è½½ï¼š
  - åŠ è½½ï¼š[loader.js.load()](frontend_projects/SmartTavern/src/workflow/loader.js:72)
  - å¸è½½ï¼š[loader.js.unload()](frontend_projects/SmartTavern/src/workflow/loader.js:127)
  - åˆ—è¡¨ï¼š[loader.js.list()](frontend_projects/SmartTavern/src/workflow/loader.js:151)

è¡Œä¸ºä¸æµç¨‹ï¼ˆmessage-forwarder.jsï¼‰
- ä»…å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼ˆrole='user'ï¼‰çš„å‘é€è¯·æ±‚ [message.js.EVT_MESSAGE_SEND_REQ](frontend_projects/SmartTavern/src/workflow/channels/message.js:80)
- è¯»å–å¯¹è¯è®¾ç½®ä¸­ plugins.messageForwarderï¼ˆendpoint/token/headersï¼‰
  - è‹¥æœªé…ç½® endpointï¼šè¿›è¡Œæœ¬åœ°æ¨¡æ‹Ÿï¼ˆç¤ºä¾‹ä¸ºå†…å®¹ upper-case å›æ˜¾ï¼‰[host.js.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:52)
  - è‹¥å·²é…ç½® endpointï¼šä»¥ POST JSON è¯·æ±‚å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ï¼ˆå¯å¸¦ Authorization Bearer token ä¸é¢å¤– headersï¼‰
  - å¤–éƒ¨å“åº”ï¼ˆæ–‡æœ¬æˆ– JSONï¼‰å°†è¢«æ ¼å¼åŒ–ååœ¨ UI å›æ˜¾ä¸ºåŠ©æ‰‹æ¶ˆæ¯ [host.js.appendMessage()](frontend_projects/SmartTavern/src/workflow/core/host.js:52)ï¼Œå¹¶æç¤ºæˆåŠŸ [host.js.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:56)
- è¯·æ±‚å¤±è´¥æ—¶ï¼šè¿½åŠ ç³»ç»Ÿæç¤ºå¹¶å±•ç¤ºé”™è¯¯ Toast [host.js.pushToast()](frontend_projects/SmartTavern/src/workflow/core/host.js:56)

é…ç½®å…¥å£ï¼ˆmessage-forwarder-config.jsï¼‰
- åœ¨å¼€å§‹é¡µæ³¨å†Œâ€œForwarder é…ç½®â€æŒ‰é’® [host.js.registerHomeButton()](frontend_projects/SmartTavern/src/workflow/core/host.js:25)
- ç‚¹å‡»åå¼¹å‡ºè¾“å…¥æ¡†ï¼Œè·å–ï¼š
  - conversationFileï¼ˆå¯¹è¯æ–‡ä»¶è·¯å¾„ï¼‰
  - endpointï¼ˆå¤–éƒ¨æœåŠ¡å™¨åœ°å€ï¼‰
  - tokenï¼ˆå¯é€‰ï¼‰
  - headersï¼ˆJSONï¼Œå¯é€‰ï¼‰
- é€šè¿‡äº‹ä»¶æ›´æ–°è®¾ç½® [settings.js.EVT_SETTINGS_UPDATE_REQ](frontend_projects/SmartTavern/src/workflow/channels/settings.js:19)ï¼Œç”±è®¾ç½®æ¡¥æ¥å™¨ [settingsBridge.js.initSettingsBridge()](frontend_projects/SmartTavern/src/workflow/controllers/settingsBridge.js:15) è´Ÿè´£è°ƒç”¨æœåŠ¡å¹¶å›å†™ç¼“å­˜

ä½¿ç”¨æ­¥éª¤
- å‰ç«¯å¯åŠ¨åï¼Œå·¥ä½œæµåŠ è½½å™¨å°†è‡ªåŠ¨æ‹‰å–åç«¯å·¥ä½œæµå¹¶ç”Ÿæ•ˆï¼ˆæ— éœ€æ”¹åŠ¨ [main.js](frontend_projects/SmartTavern/src/main.js)ï¼‰
- åœ¨å¼€å§‹é¡µç‚¹å‡»â€œForwarder é…ç½®â€ï¼Œä¸ºæŒ‡å®šå¯¹è¯è®¾ç½® endpoint/token/headers
- åœ¨æ¶ˆæ¯é¢æ¿å‘é€ç”¨æˆ·æ¶ˆæ¯ï¼Œæ’ä»¶å°†æ ¹æ®é…ç½®è½¬å‘å¹¶å›æ˜¾å¤–éƒ¨å“åº”

æœ€ä½³å®è·µ
- é…ç½®åº”ä¿å­˜åœ¨å¯¹è¯çº§ settings.plugins.messageForwarderï¼Œé¿å…å…¨å±€æ±¡æŸ“
- äº‹ä»¶ç›‘å¬åŠ¡å¿…åœ¨æ’ä»¶å¸è½½æ—¶æ¸…ç†ï¼ˆæ’ä»¶è¿”å› disposeï¼‰ï¼Œå‚è€ƒåŠ è½½å™¨å¸è½½æµç¨‹ [loader.js.unload()](frontend_projects/SmartTavern/src/workflow/loader.js:127)
- ä½¿ç”¨åŒæº + ç™½åå•ç­–ç•¥ç¡®ä¿è„šæœ¬æ¥æºå®‰å…¨ [loader.js.init()](frontend_projects/SmartTavern/src/workflow/loader.js:59)

FAQ
- ä¸ºä»€ä¹ˆä¸ä¿®æ”¹ [main.js](frontend_projects/SmartTavern/src/main.js)ï¼Ÿ
  - å·²å®ç°â€œåç«¯ä¼˜å…ˆè‡ªåŠ¨åŠ è½½â€ï¼Œå°†å·¥ä½œæµè„šæœ¬æ”¾åœ¨åç«¯ç›®å½•å³å¯è¢«å‘ç°ä¸æ‰§è¡Œï¼Œæ»¡è¶³â€œçº¯æ’ä»¶/å·¥ä½œæµè‡ªåŒ…å«â€åŸåˆ™
- å¤–éƒ¨æœåŠ¡å™¨å“åº”æ ¼å¼ä¸ç¡®å®šï¼Ÿ
  - æ’ä»¶ä¸­å¯¹å“åº”è¿›è¡Œäº†å®¹é”™å¤„ç†ï¼šæ–‡æœ¬/JSON å‡æ”¯æŒï¼ŒJSONä¼˜å…ˆå– output/result å­—æ®µï¼Œç¼ºå¤±æ—¶æŒ‰å­—ç¬¦ä¸²åŒ–å¤„ç†

## æ’ä»¶ç³»ç»Ÿèƒ½åŠ›æ€»è§ˆä¸å‰ç«¯åä½œï¼ˆåŸºäºç°æœ‰ç¤ºä¾‹ä¸è¿è¡Œæ—¶æ¡¥æ¥ï¼‰

ç›®çš„
- ä¸ºå¼€å‘è€…æä¾›â€œå¯ç”¨èƒ½åŠ›æ¸…å• + å‰ç«¯åä½œå…¥å£ + å…¸å‹ä»£ç ç¤ºä¾‹â€ï¼Œå¿«é€Ÿä¸Šæ‰‹åœ¨ `backend_projects/SmartTavern/plugins` ç›®å½•ä¸‹ç¼–å†™åç«¯æ’ä»¶ï¼ˆJSï¼‰ï¼Œå¹¶ä¸å‰ç«¯ Loader/Host/æ¡¥æ¥å±‚åä½œã€‚
- å®Œæ•´è¦†ç›–ï¼šåŠ è½½æµç¨‹ã€äº‹ä»¶é€šé“ã€UI æ’æ§½ã€è·¯ç”±å™¨ç­–ç•¥ï¼ˆHooksï¼‰ã€æ•°æ®ç›®å½• APIã€Settings æ›´æ–°ã€EventSource ä½¿ç”¨ç­‰ã€‚

â€” 

åŠ è½½ä¸è¿è¡Œæ—¶åä½œ
- å¯åŠ¨æ—¶ç»Ÿä¸€åŠ è½½æµç¨‹ï¼š[`javascript.function(loadWorkflows)`](frontend_projects/SmartTavern/src/main.js:111)
  - æµç¨‹ï¼šå…ˆåŠ è½½å‰ç«¯å›ºå®šå·¥ä½œæµï¼Œå†æ‹‰å–åç«¯æ¸…å•é¡¹ï¼ˆåç«¯è¦†ç›–åŒåï¼‰
  - æ’åºç¤ºä¾‹ï¼šä¼˜å…ˆåŠ è½½è·¯ç”±å™¨ï¼ˆprompt-routerï¼‰ï¼Œç¡®ä¿å…ˆæ³¨å…¥è·¯ç”±å™¨
- æ’ä»¶åŠ¨æ€åŠ è½½å™¨ï¼ˆç™½åå• + ç”Ÿå‘½å‘¨æœŸå›æ”¶ï¼‰ï¼š[`javascript.function(load)`](frontend_projects/SmartTavern/src/workflow/loader.js:72), [`javascript.function(isAllowed)`](frontend_projects/SmartTavern/src/workflow/loader.js:37), [`javascript.function(unload)`](frontend_projects/SmartTavern/src/workflow/loader.js:133)
  - æ”¯æŒ same-origin/blob:/data:ï¼Œä»¥åŠ /public/workflows/ ä¸ /workflows/ å‰ç¼€
  - å…¥å£æ¨¡å—å¿…é¡»å¯¼å‡º activate(host)ï¼ˆé»˜è®¤æˆ–å‘½åï¼‰ï¼Œè¿”å›å¯é€‰ dispose()
- è·¯ç”±å™¨æ³¨å…¥ï¼ˆç”±æ’ä»¶æ³¨å†Œï¼‰ï¼š[`javascript.Host.events.on('workflow.router.set', ...)`](frontend_projects/SmartTavern/src/workflow/controllers/completionBridge.js:7)
  - CompletionBridge ç›‘å¬æ³¨å…¥ï¼Œè·å–ç»Ÿä¸€è°ƒç”¨å…¥å£ï¼š[`javascript.function(initCompletionBridge)`](frontend_projects/SmartTavern/src/workflow/controllers/completionBridge.js:39)

â€” 

å¯ç”¨å®¿ä¸»èƒ½åŠ›ï¼ˆHostï¼‰
- äº‹ä»¶æ€»çº¿ï¼ˆå‘å¸ƒ/è®¢é˜…/æ¸…ç†/ç»Ÿè®¡ï¼‰ï¼š[`javascript.module(events.js)`](frontend_projects/SmartTavern/src/workflow/core/events.js:1)
- Host å•ä¾‹ï¼š[`javascript.module(host.js)`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
- UI æ’æ§½
  - å¼€å§‹é¡µæŒ‰é’®ï¼š[`javascript.function(registerHomeMenuBuiltins)`](frontend_projects/SmartTavern/src/workflow/slots/homeMenu/bootstrap.js:1)ã€[`javascript.Host.registerHomeButton()`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - ä¾§è¾¹æ é¡¹ï¼š[`javascript.function(registerSidebarBuiltins)`](frontend_projects/SmartTavern/src/workflow/slots/sidebar/bootstrap.js:1)ã€[`javascript.Host.registerSidebarItem()`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
- å…¨å±€æç¤ºä¸æ¶ˆæ¯
  - [`javascript.Host.pushToast()`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - [`javascript.Host.appendMessage()`](frontend_projects/SmartTavern/src/stores/workflow/messages.js:1)
- è¿è¡Œæ—¶è·¯ç”±å™¨ï¼ˆç»Ÿä¸€ AI è°ƒç”¨åŠ¨ä½œï¼‰
  - æ’ä»¶æ³¨å…¥ provider åï¼Œå‰ç«¯é€šè¿‡ RouterClient è°ƒç”¨ï¼š[`javascript.module(routerClient.js)`](frontend_projects/SmartTavern/src/services/routerClient.js:1)

â€” 

æ ‡å‡†äº‹ä»¶é€šé“ï¼ˆå¯ç›‘å¬/å¯è§¦å‘ï¼‰
- Completion é€šé“ï¼š[`javascript.module(completion.js)`](frontend_projects/SmartTavern/src/workflow/channels/completion.js:1)
  - è¿‡ç¨‹äº‹ä»¶ï¼šchunk/finish/usage/saved/error/end/abort
  - æ¡¥æ¥å±‚ï¼š[`javascript.module(completionBridge.js)`](frontend_projects/SmartTavern/src/workflow/controllers/completionBridge.js:1)
- Message é€šé“ï¼š[`javascript.module(message.js)`](frontend_projects/SmartTavern/src/workflow/channels/message.js:1)
  - å‘é€/ç¼–è¾‘ï¼šrequest/success/failure
  - æ¡¥æ¥å±‚ï¼š[`javascript.module(messageBridge.js)`](frontend_projects/SmartTavern/src/workflow/controllers/messageBridge.js:1)
- Branch é€šé“ï¼š[`javascript.module(branch.js)`](frontend_projects/SmartTavern/src/workflow/channels/branch.js:1)
  - åˆ†æ”¯è¡¨/åˆ‡æ¢/åˆ é™¤/é‡è¯•ï¼Œæ¡¥æ¥å±‚ï¼š[`javascript.module(branchBridge.js)`](frontend_projects/SmartTavern/src/workflow/controllers/branchBridge.js:1)
- Catalog é€šé“ï¼š[`javascript.module(catalog.js)`](frontend_projects/SmartTavern/src/workflow/channels/catalog.js:1)
  - å‰ç«¯æœåŠ¡ï¼ˆHTTP è°ƒç”¨åç«¯æ¨¡å—ç½‘å…³ï¼‰ï¼š[`javascript.module(dataCatalog.js)`](frontend_projects/SmartTavern/src/services/dataCatalog.js:1)
- Settings é€šé“ï¼š[`javascript.module(settings.js)`](frontend_projects/SmartTavern/src/workflow/channels/settings.js:1)
  - æ¡¥æ¥å±‚ï¼š[`javascript.module(settingsBridge.js)`](frontend_projects/SmartTavern/src/workflow/controllers/settingsBridge.js:1)
- Conversation æ¡¥æ¥å±‚ï¼š[`javascript.module(conversationBridge.js)`](frontend_projects/SmartTavern/src/workflow/controllers/conversationBridge.js:1)
- EventSourceï¼ˆäº‹ä»¶æ¥æºæ ‡å‡†ï¼‰ï¼š[`javascript.module(eventSource.js)`](frontend_projects/SmartTavern/src/workflow/core/eventSource.js:1), [`javascript.module(eventSource.d.ts)`](frontend_projects/SmartTavern/src/workflow/core/eventSource.d.ts:1)

â€” 

è·¯ç”±å™¨ä¸æç¤ºè¯ç­–ç•¥ï¼ˆHooksï¼‰
- è·¯ç”±å™¨æ’ä»¶ä¸»æ–‡ä»¶ï¼š[`javascript.module(prompt-router/prompt-router.js)`](backend_projects/SmartTavern/plugins/prompt-router/prompt-router.js:1)
  - åŠ¨ä½œç»Ÿä¸€ï¼šcompletion.autoã€prompt.process_view
  - æµå¼é€‰æ‹©ç”± LLM é…ç½® detail.stream å†³å®š
- Hooks ç®¡ç†å™¨ï¼š[`javascript.module(prompt-router/hooks.js)`](backend_projects/SmartTavern/plugins/prompt-router/hooks.js:1)
  - ä¾µå…¥ç‚¹ï¼šbefore/afterNormalizeAssetsã€beforeRaw/afterInsert/afterRawã€before/afterPostprocessã€before/afterVariablesSave
  - é¡ºåºè§„åˆ™ï¼šorder é™åº â†’ id å­—æ¯åº â†’ æ³¨å†Œåº seq
- ç­–ç•¥æ³¨å†Œäº‹ä»¶ï¼ˆç”±æ’ä»¶è§¦å‘ï¼Œè·¯ç”±å™¨æ¥æ”¶å¹¶è½¬å‘åˆ° Hooksï¼‰ï¼š
  - æ³¨å†Œï¼š[`javascript.Host.events.emit('prompt.router.strategy.register', strategy)`](backend_projects/SmartTavern/plugins/prompt-router/prompt-router.js:33)
  - æ³¨é”€ï¼š[`javascript.Host.events.emit('prompt.router.strategy.unregister', strategy.id)`](backend_projects/SmartTavern/plugins/prompt-router/prompt-router.js:38)

â€” 

æ•°æ®ç›®å½•ä¸è®¾ç½® APIï¼ˆå‰ç«¯æœåŠ¡ â†’ åç«¯æ¨¡å—ç½‘å…³ï¼‰
- åˆ—è¡¨ï¼š[`javascript.function(listWorkflows)`](frontend_projects/SmartTavern/src/services/dataCatalog.js:87) ç­‰
- è¯¦æƒ…ä¸æ›´æ–°ï¼š[`javascript.function(getWorkflowDetail)`](frontend_projects/SmartTavern/src/services/dataCatalog.js:159), [`javascript.function(updateWorkflowFile)`](frontend_projects/SmartTavern/src/services/dataCatalog.js:180)
- äº‹ä»¶åä½œï¼šCatalog/Settings æ¡¥æ¥å±‚ä¼šå¹¿æ’­è¯·æ±‚/å“åº”äº‹ä»¶ï¼ˆè§ API å‚è€ƒæ–‡æ¡£ï¼‰

â€” 

å…¸å‹ç¤ºä¾‹ï¼ˆå‰ç«¯è§†è§’è¯´æ˜ + åç«¯æ’ä»¶å®ç°ï¼‰

ç¤ºä¾‹ 1ï¼šå¼€å§‹é¡µæŒ‰é’® + äº‹ä»¶æç¤º
- å‚è€ƒåç«¯å®ç°ï¼š[`filename`](backend_projects/SmartTavern/plugins/demo-home/demo-home.js)
- è¦ç‚¹ï¼š
  - æ³¨å†ŒæŒ‰é’®ï¼š[`javascript.Host.registerHomeButton()`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - ç›‘å¬ actionIdï¼š[`javascript.Host.events.on()`](frontend_projects/SmartTavern/src/workflow/core/events.js:1)
  - æç¤ºä¸æ¶ˆæ¯å›æ˜¾ï¼š[`javascript.Host.pushToast()`](frontend_projects/SmartTavern/src/workflow/core/host.js:1), [`javascript.Host.appendMessage()`](frontend_projects/SmartTavern/src/stores/workflow/messages.js:1)

ç¤ºä¾‹ 2ï¼šä¾§è¾¹æ é¡¹ï¼ˆå¯è§/ç¦ç”¨æ§åˆ¶ï¼‰
- å‚è€ƒåç«¯å®ç°ï¼š[`filename`](backend_projects/SmartTavern/plugins/demo-sidebar/demo-sidebar.js)
- è¦ç‚¹ï¼š
  - æ³¨å†Œä¾§è¾¹æ é¡¹ï¼š[`javascript.Host.registerSidebarItem()`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - visibleWhen/disabledWhen å›è°ƒæ¥æ”¶ä¸Šä¸‹æ–‡ï¼ˆview/theme ç­‰ï¼‰

ç¤ºä¾‹ 3ï¼šäº‹ä»¶å¢å¼ºï¼ˆæ¶ˆæ¯å‘é€/ç¼–è¾‘ï¼‰
- å‚è€ƒåç«¯å®ç°ï¼š[`filename`](backend_projects/SmartTavern/plugins/demo-message-enhancer/demo-message-enhancer.js)
- è¦ç‚¹ï¼š
  - åŠ¨æ€å¯¼å…¥é€šé“å¸¸é‡ï¼š`await import(\`\${window.location.origin}/src/workflow/channels/message.js\`)`
  - ç›‘å¬å‘é€/ç¼–è¾‘ success/failure å¹¶ pushToast + appendMessage

ç¤ºä¾‹ 4ï¼šå¤–éƒ¨è½¬å‘ + è®¾ç½®å…¥å£
- å‚è€ƒåç«¯å®ç°ï¼š[`filename`](backend_projects/SmartTavern/plugins/message-forwarder/message-forwarder.js), [`filename`](backend_projects/SmartTavern/plugins/message-forwarder-config/message-forwarder-config.js)
- è¦ç‚¹ï¼š
  - ç›‘å¬ `EVT_MESSAGE_SEND_REQ` æ„é€  HTTP è¯·æ±‚å¹¶å›æ˜¾å“åº”
  - é€šè¿‡ Settings é€šé“å†™å…¥å¯¹è¯ settings.plugins.messageForwarder

ç¤ºä¾‹ 5ï¼šæ¥æºæ„ŸçŸ¥ï¼ˆEventSourceï¼‰
- å‚è€ƒåç«¯å®ç°ï¼š[`filename`](backend_projects/SmartTavern/plugins/demo-source-aware/demo-source-aware.js)
- è¦ç‚¹ï¼š
  - ä½¿ç”¨ payload.source.viewType/intentType/priority/batchId/componentId
  - å®šæœŸè¾“å‡ºç»Ÿè®¡ä¸è·¨ç»„ä»¶çŠ¶æ€åè°ƒ

ç¤ºä¾‹ 6ï¼šè§†å›¾å†…æ³¨å…¥ï¼ˆçº¿ç¨‹è§†å›¾æ‚¬æµ®å¡ç‰‡ï¼‰
- å‚è€ƒåç«¯å®ç°ï¼š[`filename`](backend_projects/SmartTavern/plugins/demo-threaded-image/demo-threaded-image.js)
- è¦ç‚¹ï¼š
  - æ³¨å†Œä¾§è¾¹æ å…¥å£ï¼Œç‚¹å‡»åæ’å…¥/ç§»é™¤ DOM
  - å¸è½½æ—¶æ¸…ç†äº‹ä»¶ä¸ DOM èŠ‚ç‚¹

ç¤ºä¾‹ 7ï¼šè·¯ç”±å™¨ç­–ç•¥ï¼ˆHooksï¼‰
- å‚è€ƒç­–ç•¥ï¼š[`filename`](backend_projects/SmartTavern/plugins/example-manifest-bundle/strategies/raw-phase/index.js)
- è¦ç‚¹ï¼š
  - åœ¨æ’ä»¶ä¸­æ„é€ ç­–ç•¥å¯¹è±¡å¹¶è§¦å‘æ³¨å†Œ/æ³¨é”€äº‹ä»¶
  - ä½¿ç”¨ beforeRaw/afterRaw è§„èŒƒåŒ–å†å²ä¸è¿‡æ»¤ç©ºæ¶ˆæ¯

â€” 

å¼€å‘è§„èŒƒä¸æœ€ä½³å®è·µ
- æ¨¡å—å¯¼å‡ºï¼šæ’ä»¶å¿…é¡»å¯¼å‡º activate(host)ï¼Œè¿”å›å¯é€‰ dispose()
- èƒ½åŠ›æ‹†åˆ†ï¼šå°†â€œæç¤ºè¯ç­–ç•¥å…¥å£â€ä¸â€œUI/æ¡¥æ¥å…¥å£â€åˆ†ç¦»ä¸ºå¤šä¸ª JS æ–‡ä»¶ï¼Œä½¿ç”¨ manifest.json entries ç®¡ç†åŠ è½½ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
- å¹‚ç­‰ä¸å†²çªé¿å…ï¼šå¤šä¸ªç­–ç•¥å¹¶è¡Œæ—¶å°½é‡æœ€å°åŒ–ä¿®æ”¹å¹¶ä¿è¯é‡å¤æ‰§è¡Œå®‰å…¨
- ç™½åå•ï¼šLoader é»˜è®¤å…è®¸ same-origin/blob:/data: ä¸ä¸¤ä¸ªè·¯å¾„å‰ç¼€ï¼Œå¿…è¦æ—¶é€šè¿‡ `PluginLoader.init({ whitelist })` æ‰©å±•
- é”™è¯¯ä¸å…œåº•ï¼šæ‰€æœ‰å¤–éƒ¨è°ƒç”¨ï¼ˆåç«¯ API/HTTPï¼‰å¿…é¡»å…·å¤‡é”™è¯¯æç¤ºä¸å…œåº•é€»è¾‘
- æ¸…ç†ï¼šdispose() å¿…é¡»è§£é™¤äº‹ä»¶ç›‘å¬ä¸ç§»é™¤ DOMï¼Œé¿å…å†…å­˜æ³„æ¼

â€” 

æ¸…ç†ç¤ºä¾‹æ’ä»¶ï¼ˆå®Œæˆè‡ªæœ‰æ’ä»¶å¼€å‘åï¼‰
- å»ºè®®åˆ é™¤ä¸‹åˆ—æ¼”ç¤º/æµ‹è¯•ç›®å½•ï¼Œä¿ç•™ç”Ÿäº§æ’ä»¶ä¸è·¯ç”±å™¨ï¼š
  - demo-homeã€demo-message-enhancerã€demo-sidebarã€demo-source-awareã€demo-threaded-image
  - example-backendã€message-forwarderã€message-forwarder-config
  - example-manifest-bundle
- åˆ é™¤å‰è¯·ç¡®ä¿è·¯ç”±å™¨ï¼ˆprompt-routerï¼‰å·²åœ¨åç«¯æ¸…å•è¿”å›å¹¶åŠ è½½ï¼Œå¦åˆ™ç»Ÿä¸€åŠ¨ä½œå…¥å£ä¸å¯ç”¨ã€‚

å‚è€ƒ
- Loader è¿è¡Œæ—¶ï¼š[`javascript.module(loader.js)`](frontend_projects/SmartTavern/src/workflow/loader.js:1)
- å¯åŠ¨åŠ è½½å…¥å£ï¼š[`javascript.function(loadWorkflows)`](frontend_projects/SmartTavern/src/main.js:111)
- è·¯ç”±å™¨æ¡¥æ¥ï¼š[`javascript.module(completionBridge.js)`](frontend_projects/SmartTavern/src/workflow/controllers/completionBridge.js:1)
- API å‚è€ƒä¸äº‹ä»¶å¸¸é‡ï¼š[`markdown.APIå‚è€ƒ_äº‹ä»¶ä¸çŠ¶æ€.md`](frontend_projects/SmartTavern/docs/APIå‚è€ƒ_äº‹ä»¶ä¸çŠ¶æ€.md)

## JS-only å¿«é€Ÿä¸Šæ‰‹ï¼ˆæ— éœ€é˜…è¯»å†…éƒ¨æºç ï¼‰

ç›®æ ‡
- å¼€å‘è€…ä»…å‡­æœ¬èŠ‚å³å¯å®Œæˆæ’ä»¶å¼€å‘ä¸è”è°ƒï¼Œæ— éœ€æ‰“å¼€å†…éƒ¨æºæ–‡ä»¶ã€‚
- æ‰€æœ‰ç¤ºä¾‹å‡ä¸ºçº¯ JavaScriptï¼ˆä¸ä½¿ç”¨ TypeScript ç±»å‹æˆ–æ¥å£ï¼‰ã€‚

ä½ éœ€è¦çš„å”¯ä¸€ API ä¸äº‹ä»¶
- Host å•ä¾‹ï¼ˆåˆå§‹åŒ–ä¸å¯¹å¤–èƒ½åŠ›ï¼‰ï¼š[`javascript.module(Host)`](frontend_projects/SmartTavern/src/workflow/core/host.js:1)
  - äº‹ä»¶æ€»çº¿ï¼š[`javascript.Host.events`](frontend_projects/SmartTavern/src/workflow/core/host.js:72)
    - è®¢é˜…ï¼šon(event, handler)ã€once(event, handler)
    - å–æ¶ˆï¼šoff(event, handler)ã€clear()
    - æ´¾å‘ï¼šemit(event, payload)
  - UI æ’æ§½ï¼š
    - å¼€å§‹é¡µæŒ‰é’®ï¼š[`javascript.Host.registerHomeButton(entry)`](frontend_projects/SmartTavern/src/workflow/core/host.js:97)ã€[`javascript.Host.unregisterHomeButton(id)`](frontend_projects/SmartTavern/src/workflow/core/host.js:98)
    - ä¾§è¾¹æ é¡¹ï¼š[`javascript.Host.registerSidebarItem(entry)`](frontend_projects/SmartTavern/src/workflow/core/host.js:101)ã€[`javascript.Host.unregisterSidebarItem(id)`](frontend_projects/SmartTavern/src/workflow/core/host.js:102)
  - æ¶ˆæ¯ä¸æç¤ºï¼š
    - è¿½åŠ æ¶ˆæ¯ï¼š[`javascript.Host.appendMessage(message)`](frontend_projects/SmartTavern/src/workflow/core/host.js:104)
    - æç¤ºï¼š[`javascript.Host.pushToast(toast)`](frontend_projects/SmartTavern/src/workflow/core/host.js:105)

- äº‹ä»¶å¸¸é‡ï¼ˆç›´æ¥ import ä½¿ç”¨ï¼‰ï¼š
  - æ¶ˆæ¯é€šé“ï¼ˆå‘é€/ç¼–è¾‘ï¼‰ï¼š[`javascript.module(message.js)`](frontend_projects/SmartTavern/src/workflow/channels/message.js:1)
    - SEND_REQ/SEND_OK/SEND_FAILã€EDIT_REQ/EDIT_OK/EDIT_FAILï¼š[`javascript.constant(EVT_MESSAGE_SEND_OK)`](frontend_projects/SmartTavern/src/workflow/channels/message.js:81)
  - å®Œæˆé€šé“ï¼ˆAIè¡¥å…¨è¯·æ±‚ä¸è¿‡ç¨‹å›è°ƒï¼‰ï¼š[`javascript.module(completion.js)`](frontend_projects/SmartTavern/src/workflow/channels/completion.js:1)
    - REQUEST/CHUNK/FINISH/USAGE/SAVED/ERROR/END/ABORTï¼š[`javascript.constant(EVT_COMPLETION_REQ)`](frontend_projects/SmartTavern/src/workflow/channels/completion.js:55)
  - çº¿ç¨‹è§†å›¾ UI é€šé“ï¼ˆå ä½åˆ›å»ºï¼‰ï¼š[`javascript.module(threaded.js)`](frontend_projects/SmartTavern/src/workflow/channels/threaded.js:1)
    - åŠ©æ‰‹å ä½åˆ›å»ºï¼š[`javascript.constant(EVT_THREAD_ASSIST_PLACEHOLDER_CREATE)`](frontend_projects/SmartTavern/src/workflow/channels/threaded.js:32)
  - åˆ†æ”¯é€šé“ï¼ˆåˆ†æ”¯è¡¨/åˆ‡æ¢/åˆ é™¤/é‡è¯•/æ™ºèƒ½é‡è¯•ï¼‰ï¼š[`javascript.module(branch.js)`](frontend_projects/SmartTavern/src/workflow/channels/branch.js:1)
    - ä¾‹å¦‚åŠ©æ‰‹é‡è¯•æˆåŠŸï¼š[`javascript.constant(EVT_BRANCH_RETRY_ASSIST_OK)`](frontend_projects/SmartTavern/src/workflow/channels/branch.js:66)

- è¿è¡Œæ—¶åŠ è½½å™¨ï¼ˆå¦‚éœ€åœ¨å‰ç«¯å†…éƒ¨åŠ è½½æ’ä»¶ï¼‰ï¼š[`javascript.function(PluginLoader.load)`](frontend_projects/SmartTavern/src/workflow/loader.js:78)
  - æ”¯æŒç™½åå•ï¼š[`javascript.declaration(__whitelist)`](frontend_projects/SmartTavern/src/workflow/loader.js:31)
  - å¯åŠ¨åŠ è½½å…¥å£ï¼š[`javascript.function(loadWorkflows)`](frontend_projects/SmartTavern/src/main.js:111)

â€” 

å¼€å‘æµç¨‹ï¼ˆåç«¯æ’ä»¶ï¼Œmanifest-only ä¸¥æ ¼æ¨¡å¼ï¼‰
1) åœ¨åç«¯ç›®å½•åˆ›å»ºä½ çš„æ’ä»¶åŒ…ä¸å…¥å£ JS æ–‡ä»¶ï¼š
   - ä½ç½®ï¼šbackend_projects/SmartTavern/plugins/my-plugin/
   - å…¥å£ï¼šmy-plugin/index.jsï¼ˆå¯¼å‡º activate(host)ï¼‰
2) åœ¨æ’ä»¶æ ¹æ·»åŠ  manifest.json å¹¶å£°æ˜è¦åŠ è½½çš„ JS æ–‡ä»¶ï¼ˆç›¸å¯¹è·¯å¾„ï¼Œå¿…é¡»æ˜¯ .jsï¼‰ï¼š
   - ç¤ºä¾‹æ¸…å•ï¼š[`filename`](backend_projects/SmartTavern/plugins/example-manifest-bundle/manifest.json)
3) ç¼–å†™å…¥å£ï¼ˆactivateï¼‰å¹¶ä½¿ç”¨äº‹ä»¶æˆ– UI æ’æ§½å®Œæˆä½ çš„åŠŸèƒ½ã€‚
4) å¯åŠ¨åº”ç”¨ï¼Œå‰ç«¯é€šè¿‡æ•°æ®ç›®å½• API è·å–æ¸…å•å¹¶æŒ‰ entries åŠ¨æ€åŠ è½½ï¼š
   - åŠ è½½å…¥å£ï¼š[`javascript.function(loadWorkflows)`](frontend_projects/SmartTavern/src/main.js:111)
   - åŠ¨æ€å¯¼å…¥ï¼š[`javascript.function(load)`](frontend_projects/SmartTavern/src/workflow/loader.js:95)
5) éªŒè¯ä¸è°ƒè¯•ï¼š
   - è§‚å¯Ÿé¡µé¢ Toast æç¤ºï¼ˆHost.pushToastï¼‰
   - åœ¨æµè§ˆå™¨æ§åˆ¶å°ä½¿ç”¨ window.loader.list()ï¼ˆå¦‚éœ€è¦è°ƒè¯•åŠ è½½å™¨ï¼‰

â€” 

JS ç¤ºä¾‹åº“ï¼ˆæ‹·è´å³ç”¨ï¼‰

ç¤ºä¾‹ 1ï¼šå¼€å§‹é¡µæŒ‰é’® + äº‹ä»¶æç¤ºï¼ˆUI æ’æ§½ï¼‰
```js
// backend_projects/SmartTavern/plugins/my-home/index.js
export default function activate(host) {
  const offDemo = host.events.on('ui.home.demo', (params) => {
    host.pushToast?.({ type: 'success', message: `Demo clicked: ${JSON.stringify(params)}`, timeout: 2500 })
    host.appendMessage?.({ role: 'system', content: 'Demo plugin executed' })
  })

  const disposeBtn = host.registerHomeButton({
    id: 'home.demo',
    label: 'Demo Plugin',
    icon: 'zap',
    order: 90,
    actionId: 'ui.home.demo',
    params: { from: 'demo-plugin' },
    tooltip: 'A demo workflow button',
  })

  return () => { try { disposeBtn?.(); offDemo?.() } catch (_) {} }
}
```

ç¤ºä¾‹ 2ï¼šç›‘å¬æ¶ˆæ¯äº‹ä»¶åšå¢å¼ºï¼ˆMessage é€šé“ï¼‰
```js
// backend_projects/SmartTavern/plugins/my-enhancer/index.js
export default function activate(host) {
  const baseUrl = window.location.origin
  let Msg = null

  (async () => { Msg = await import(`${baseUrl}/src/workflow/channels/message.js`) })().catch(() => {})

  const disposers = []
  disposers.push(host.events.on('workflow.message.send.success', (p) => {
    if (p?.role === 'user') {
      host.pushToast?.({ type: 'success', message: `æ¶ˆæ¯å·²å‘é€ï¼ˆ${(p.content||'').length}å­—ï¼‰`, timeout: 1800 })
      host.appendMessage?.({ role: 'system', content: 'å¢å¼ºï¼šå·²æ”¶åˆ°ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯' })
    }
  }))

  return () => { try { disposers.forEach(fn => fn?.()) } catch (_) {} }
}
```

ç¤ºä¾‹ 3ï¼šç¼–æ’å ä½ä¸ AI è°ƒç”¨ï¼ˆThreaded + Completionï¼‰
```js
// backend_projects/SmartTavern/plugins/my-orchestrator/index.js
export default function activate(host) {
  const baseUrl = window.location.origin
  let Threaded = null, Completion = null
  (async () => {
    Threaded = await import(`${baseUrl}/src/workflow/channels/threaded.js`)
    Completion = await import(`${baseUrl}/src/workflow/channels/completion.js`)
  })().catch(() => {})

  const off = host.events.on('workflow.message.send.success', (p) => {
    const { conversationFile, role } = p || {}
    if (!conversationFile || role !== 'user') return
    const tag = `temp_${Date.now()}`
    setTimeout(() => {
      host.events.emit(Threaded.EVT_THREAD_ASSIST_PLACEHOLDER_CREATE, { conversationFile, tempNodeId: tag })
      host.events.emit(Completion.EVT_COMPLETION_REQ, { conversationFile, mode: 'auto', tag })
    }, 0)
  })
  return () => off?.()
}
```

ç¤ºä¾‹ 4ï¼šæç¤ºè¯åå¤„ç†ç­–ç•¥ï¼ˆHooksï¼Œè·¯ç”±å™¨è½¬å‘æ³¨å†Œï¼‰
```js
// backend_projects/SmartTavern/plugins/my-strategy/index.js
export default function activate(host) {
  const strategy = {
    id: 'my.router.strategy',
    order: 80,
    beforeRaw(history, ctx) {
      const out = Array.isArray(history) ? history.map(m => ({
        role: String(m.role || '').toLowerCase(),
        content: String(m.content || '').trim()
      })) : []
      return { history: out }
    },
    afterRaw(messages, ctx) {
      const out = Array.isArray(messages) ? messages.filter(m => String(m?.content || '').trim().length > 0) : []
      return { messages: out }
    },
    beforeVariablesSave(finalVars, ctx) {
      const v = Object.assign({}, finalVars || {})
      v.last_save_ts = Date.now()
      return v
    },
  }

  host.events.emit('prompt.router.strategy.register', strategy)
  return () => host.events.emit('prompt.router.strategy.unregister', strategy.id)
}
```

â€” 

å¸¸è§é—®é¢˜ï¼ˆJS-onlyï¼‰
- æ˜¯å¦éœ€è¦ TypeScriptï¼Ÿ
  - ä¸éœ€è¦ã€‚æ’ä»¶ä»…ä½¿ç”¨ JSï¼›ç¤ºä¾‹å‡ä¸º JavaScriptã€‚
- å¦‚ä½•æ‰¾åˆ°äº‹ä»¶åï¼Ÿ
  - ç›´æ¥ä»äº‹ä»¶é€šé“æ¨¡å— import å¸¸é‡ï¼š[`javascript.module(message.js)`](frontend_projects/SmartTavern/src/workflow/channels/message.js:1)ã€[`javascript.module(completion.js)`](frontend_projects/SmartTavern/src/workflow/channels/completion.js:1)ã€[`javascript.module(threaded.js)`](frontend_projects/SmartTavern/src/workflow/channels/threaded.js:1)ã€[`javascript.module(branch.js)`](frontend_projects/SmartTavern/src/workflow/channels/branch.js:1)
- å¦‚ä½•åŠ è½½åç«¯æ’ä»¶ï¼Ÿ
  - ä½¿ç”¨ manifest.json entries ä¸¥æ ¼å£°æ˜ JS æ–‡ä»¶ï¼›åç«¯æ¸…å•è¿”å›ï¼Œå‰ç«¯ Loader åŠ¨æ€åŠ è½½ï¼š[`javascript.function(loadWorkflows)`](frontend_projects/SmartTavern/src/main.js:111)
- é»˜è®¤ç¼–æ’å™¨æ”¾å“ªé‡Œï¼Ÿ
  - å†…ç½®é»˜è®¤ç¼–æ’å™¨ä½äºå‰ç«¯æºç ï¼š[`filename`](frontend_projects/SmartTavern/src/workflow/workflows/default-thread-orchestrator.js)ã€‚åç«¯æ’ä»¶ç”¨äºå¯ç¼–è¾‘çš„æ‰©å±•å’Œç­–ç•¥ã€‚

â€” 

å®è·µå»ºè®®
- å°†â€œUIå…¥å£ï¼ˆæŒ‰é’®/ä¾§è¾¹æ ï¼‰â€ä¸â€œæç¤ºè¯ç­–ç•¥ï¼ˆHooksï¼‰â€æ‹†åˆ†ä¸ºå¤šä¸ª JSï¼Œä¾¿äºç»´æŠ¤ä¸æ’åºã€‚
- åœ¨ç­–ç•¥å¯¹è±¡è®¾ç½®ç¨³å®š id ä¸æ¸…æ™°çš„ orderï¼›å†²çªæ—¶éµå¾ªâ€œorder é™åº â†’ id å­—æ¯åº â†’ æ³¨å†Œåº seqâ€çš„è§„åˆ™ï¼š[`javascript.function(sortHooks)`](backend_projects/SmartTavern/plugins/prompt-router/hooks.js:63)
- æ‰€æœ‰å¤–éƒ¨è°ƒç”¨ï¼ˆHTTP/åç«¯ APIï¼‰éœ€åšå¥½é”™è¯¯å…œåº•å¹¶ç”¨ Host.pushToast æç¤ºã€‚
- å¸è½½æ—¶åŠ¡å¿…æ¸…ç†äº‹ä»¶ä¸ DOMï¼Œé¿å…æ³„æ¼ã€‚

è¿™ä»½ JS-only æŒ‡å—è¦†ç›–äº†æ’ä»¶å¼€å‘æ‰€éœ€çš„å…¨éƒ¨æµç¨‹ä¸æ¥å£ï¼Œæ— éœ€é˜…è¯»å†…éƒ¨å®ç°å³å¯å®Œæˆå¼€å‘ä¸è”è°ƒã€‚
