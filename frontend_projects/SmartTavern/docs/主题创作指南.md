# SmartTavern 主题创作指南（面向静态编译产物）

适用范围：当应用以 Vite 构建为静态 HTML + CSS + JS（压缩/混淆）后，第三方主题作者如何可靠地实现“换肤与美化”，且无需理解编译后的内部结构。

目标：
- 仅导入“一个主题文件”即可生效（无 JS 亦可完成大多数换肤）
- 可选启用“受控 JS 扩展”实现更复杂美化（例如将纯色背景替换为图片背景、视差特效等）
- 不依赖编译后的类名或内部 DOM 细节，通过“稳定选择器契约 + 设计令牌（CSS Variables）”对外暴露稳定锚点
- 提供回退与安全边界，保障生产可用

提示：本指南与总览文档的“主题 2.0 方案”（章节 21.x）与“静态产物执行机制”（章节 22.x）互为配套。

---

## 0. TL;DR（3 步完成换肤）

1) 准备一个主题包（Theme Pack）
- 方式 A：JSON 单文件（.sttheme.json），内含 tokens 与可选 css/图片（data:URI）
- 方式 B：压缩包（.sttheme），Zip 内含 manifest.json + assets（图片/字体）
2) 在应用侧边栏“主题/主体（Themes）”导入
- 无 JS 即可应用 tokens + CSS 覆盖
- 如需脚本扩展（动态背景等），打开“允许主题脚本 + 信任该主题脚本”
3) 如需分享，可在“主题”页面导出为 .sttheme.json 或 .sttheme 文件

无需理解编译后的代码；仅凭“稳定选择器与变量令牌”即可对外观进行高覆盖率美化。

---

## 1. 主题包（Theme Pack）格式

主题包提供两种形态：
- 单文件 JSON：example.sttheme.json（适合轻量主题）
- Zip 打包：example.sttheme（适合包含多图/字体的大主题）

Zip 内部结构建议：
```
example.sttheme
├─ manifest.json          # 必须：主题清单
├─ assets/
│  ├─ images/...
│  └─ fonts/...
└─ styles/optional.css    # 可选：附加 CSS
```

manifest.json 最小示例（无 JS，仅 tokens 覆盖 + 附加 CSS）：
```json
{
  "name": "Ocean Breeze",
  "version": "1.0.0",
  "author": "Theme Studio",
  "tokens": {
    "--st-color-bg": "17 24 39",
    "--st-color-text": "243 244 246",
    "--st-surface": "31 41 55",
    "--st-primary": "129 140 248"
  },
  "css": "/* 可选：附加全局 CSS */\n[data-scope=\"app-shell\"]{backdrop-filter: blur(4px)}",
  "images": {
    "app-bg": "data:image/webp;base64,AAA..."
  }
}
```

manifest.json 高级示例（含脚本扩展，需显式信任）：
```json
{
  "name": "Ocean Breeze+",
  "version": "1.1.0",
  "author": "Theme Studio",
  "tokens": {
    "--st-surface-bg-image": "url('data:image/webp;base64,AAA...')",
    "--st-surface-bg-size": "cover",
    "--st-surface-bg-position": "center center",
    "--st-surface-bg-repeat": "no-repeat"
  },
  "css": ".message-item[data-part=\"bubble\"]{border-radius: 16px}",
  "images": { "app-bg": "assets/images/ocean.webp" },
  "permissions": [
    "style.vars", "style.css", "style.class",
    "dom.mutate.style",
    "assets.external:https://cdn.example.com",
    "events.route"
  ],
  "scopes": [
    "body", ".app-shell", ".message-item"
  ],
  "script": {
    "enable": true,
    "sandbox": "iframe",
    "entry": "inline",
    "code": "function activate(api){ api.replaceBackground(\"body\", api.images[\"app-bg\"], {size:\"cover\", position:\"center\"}); }"
  }
}
```

字段说明（核心）：
- tokens：CSS 变量（设计令牌）覆盖，零 JS 即可换肤
- css（可选）：附加全局 CSS（将被安全校验后注入）；禁止内联 <script>
- images/fonts（可选）：主题资源，可 data:URI 或 zip 相对路径
- permissions/scopes（可选）：声明脚本可用能力与允许操作的选择器范围
- script（可选）：主题脚本声明，默认禁用；需用户显式“允许主题脚本 + 信任该主题”

---

## 2. 如何在“静态发布”的应用中启用主题

方式 A：UI 导入（推荐）
- 打开“侧边栏 → 主题/主体（Themes）”，选择 .sttheme.json 或 .sttheme
- 导入后即刻应用 tokens + CSS
- 如包含脚本：需在“应用设置（App Settings）”开启“允许主题脚本”，并在主题页勾选“信任该主题脚本”

方式 B：URL 参数（便于分享）
- 访问时带上 `?theme=/themes/ocean.sttheme.json`
- 首屏将尝试加载主题（仍需遵循脚本信任逻辑）

持久化：
- 轻量主题（JSON/data:）存 localStorage
- 大主题（Zip/多资源）建议存 IndexedDB

回退：
- 可一键“禁用脚本，仅保留样式”
- 可一键“重置为默认主题”

---

## 3. 稳定选择器契约（Stable Selectors Contract）

不要依赖编译后的类名或 DOM 结构。主题仅能使用“稳定数据标记”作为选择器锚点，这些标记会跨版本尽量保持兼容：

顶层锚点：
- `body[data-app="smarttavern"]`
- `#app`

语义作用域（scope）标记（组件根）：
- `[data-scope="app-shell"]`（主布局）
- `[data-scope="sidebar"]`、`[data-scope="sidebar-nav"]`
- `[data-scope="settings-view"]`（设置页容器）
- 聊天：
  - `[data-scope="chat-threaded"]`
  - `[data-scope="message-list"]`
  - `[data-scope="message-item"]`
- 沙盒：
  - `[data-scope="chat-sandbox"]`
- 7 个设置页面：
  - `[data-scope="themes-view"]`、`[data-scope="presets-view"]`、`[data-scope="worldbook-view"]`、`[data-scope="characters-view"]`、`[data-scope="persona-view"]`、`[data-scope="regex-view"]`、`[data-scope="appsettings-view"]`

部件（part）标记（组件内部可定制部位）：
- `[data-part="avatar"]`、`[data-part="bubble"]`、`[data-part="toolbar"]`、`[data-part="content"]`、`[data-part="input"]`

契约发布物（机器可读）：
- contract.json（随应用发布）：列出当前版本可用的 scopes/parts/tokens 清单与说明
- 当契约升级改变了选择器，应用会提供映射与兼容提示

建议：
- CSS 注入只使用以上稳定选择器；不要写诸如 `.a .b .c .d` 之类基于内部结构的选择器
- 主题脚本操作 DOM 时，也仅能操作“白名单选择器集合”（scopes）

---

## 4. 设计令牌（CSS Variables）清单

核心令牌（建议最小集，可扩展）：
- 颜色：
  - `--st-color-bg`, `--st-color-text`, `--st-color-weak`
  - `--st-surface`, `--st-surface-2`
  - `--st-primary`, `--st-primary-contrast`
  - `--st-border`, `--st-accent`, `--st-success`, `--st-warning`, `--st-danger`
- 圆角：
  - `--st-radius-sm`, `--st-radius-md`, `--st-radius-lg`
- 阴影：
  - `--st-shadow-sm`, `--st-shadow-md`, `--st-shadow-lg`
- 密度（间距）：
  - `--st-spacing-xs`, `--st-spacing-sm`, `--st-spacing-md`, `--st-spacing-lg`
- 字体与排版：
  - `--st-font-body`, `--st-font-mono`
  - `--st-font-size`, `--st-line-height`
- 背景图 Hook：
  - `--st-surface-bg-image`
  - `--st-surface-bg-size`, `--st-surface-bg-position`, `--st-surface-bg-repeat`, `--st-surface-bg-opacity`

应用层示例（主题仅需覆盖变量值，无需 JS）：
```css
[data-scope="app-shell"]{
  background-color: rgb(var(--st-color-bg));
  background-image: var(--st-surface-bg-image, none);
  background-size: var(--st-surface-bg-size, cover);
  background-position: var(--st-surface-bg-position, center center);
  background-repeat: var(--st-surface-bg-repeat, no-repeat);
}
```

在 manifest.tokens 中设置变量：
```json
{
  "tokens": {
    "--st-surface-bg-image": "url('data:image/webp;base64,AAA...')",
    "--st-surface-bg-size": "cover",
    "--st-surface-bg-position": "center center",
    "--st-surface-bg-repeat": "no-repeat"
  }
}
```

---

## 5. 脚本扩展（可选，需显式信任）

如需动态美化（例如“将纯色背景替换为图片背景”、“视差/滚动动效”、“动态雾化”），可以提供脚本扩展。默认不执行，除非用户：
- 在“应用设置”开启“允许主题脚本”
- 在“主题页面”勾选“信任该主题脚本”

执行模型（按安全到高风险分级）：
- Level 0：No-JS（默认）——仅 tokens + CSS
- Level 1：Sandbox-Style（iframe，无同源/无网络）——通过白名单 API 做样式增强
- Level 2：Sandbox-Extended（iframe + 扩展只读/样式能力）
- Level 3：Trusted Theme Script（受信脚本）——“接近任意”的 UI 美化（仅限样式/容器层），仍受作用域与域名白名单限制

白名单 API（示例，具体以应用版本为准）：
- `setCSSVar(name, value)`
- `addGlobalCSS(cssText)`
- `replaceBackground(selector, imageUrl, options)`
- `addClass(selector, className)` / `removeClass(selector, className)`
- `onRouteChange(handler)`
- `getThemeAssets()`

示例：将 body 的纯色背景替换为主题图片
```js
function activate(api){
  api.replaceBackground("body", api.images["app-bg"], {
    size:"cover", position:"center", repeat:"no-repeat", opacity:1
  });
}
```

清理：
- 切换/停用主题时，宿主会调用 `deactivate()` 并清理注入（主题可自行补充）

限制与建议：
- 禁止读取业务数据/会话内容/鉴权信息
- 外部资源仅允许声明的白名单域名，受 CSP 限制
- 仅允许“样式层/容器层”的变更，业务逻辑与数据流由应用掌控

---

## 6. 与编译产物的关系

- 主题作者不需要阅读/依赖编译后的类名；只使用“稳定选择器契约 + 令牌”
- 应用在运行时注入主题：先应用 tokens，再注入 CSS；如启用脚本则初始化沙盒并执行
- 提供 URL 直载：`?theme=/themes/xxx.sttheme.json`（便于静态托管/分享）

---

## 7. 性能建议

- 优先用 tokens 与 CSS（无 JS 执行开销）
- 图片尽量使用 webp/avif；内联 data:URI 仅适合小图
- 大型资源放 Zip 并惰性读取；必要时分片加载
- 控制注入 CSS 的体积与选择器复杂度；避免 `*` 与超长后代链

---

## 8. 版本兼容与契约变更

- 契约文件（contract.json）包含 contractVersion
- 当应用升级导致选择器/token 变更时，将提升版本并提供映射
- 旧主题将“尽力兼容”并在主题页面提示差异；必要时自动降级为“仅样式模式”

---

## 9. 疑难解答（FAQ）

- 问：编译后的 HTML 类名看不懂，怎么写 CSS？
  - 答：不要用类名与内部结构；只用“稳定选择器（data-scope / data-part）”与“令牌变量”
- 问：可以实现任意美化吗？
  - 答：默认不可以；启用“受信主题脚本”后，可实现接近任意的 UI 美化（样式/容器层），但有安全边界与作用域限制
- 问：如何在静态部署上直接启用主题？
  - 答：将主题放在可访问路径上，使用 `?theme=...` 参数，或在 UI 主题页面导入
- 问：我的主题脚本没有生效？
  - 答：检查“应用设置”中的“允许主题脚本”是否开启、当前主题是否勾选“信任脚本”、浏览器控制台是否有 CSP 拦截、资源域名是否在白名单
- 问：如何回退？
  - 答：在主题页面一键禁用脚本或重置为默认主题

---

## 10. 校验清单（给主题作者的自测）

- [ ] manifest.json 结构完整，包含 name/version/tokens（必要）
- [ ] 仅使用稳定选择器；未引用内部类名
- [ ] 覆盖的 tokens 在本机预览有效（可用 URL 参数测试）
- [ ] 附加 CSS 无危险规则与无效选择器
- [ ] 如包含脚本：仅使用白名单 API；声明了所需 permissions 与 scopes
- [ ] 使用了体积友好的图片（webp/avif）与合理的 CSS 复杂度
- [ ] 导入/导出流程在 UI 中可顺利往返

---

附录：逻辑选择器（供脚本内简化使用）
- `$app` = `body[data-app="smarttavern"]`
- `$appShell` = `[data-scope="app-shell"]`
- `$sidebar` = `[data-scope="sidebar"]`
- `$messageList` = `[data-scope="message-list"]`
- `$messageItem` = `[data-scope="message-item"]`

说明：逻辑选择器主要用于“脚本 API”的 selector 参数，宿主会在运行时映射到真实选择器；CSS 文本建议直接使用稳定选择器（不建议在 CSS 中使用逻辑名替换，以减少解析复杂度）。

---

版权与免责声明：
- 主题由作者自行创作与发布；启用“受信主题脚本”意味着你理解并接受潜在风险
- 应用会尽力提供回退与沙盒限制，但不对第三方主题脚本引发的风格错乱与性能问题承担责任
## v1 主题包（Theme Pack）规范与运行指南

本节描述 SmartTavern v1 主题系统：主题包结构、令牌（tokens）与稳定选择器契约、导入与应用方式、安全策略与最佳实践。

- 运行时与关键文件
  - 主题运行时管理器：[manager.js](../src/features/themes/manager.js:1)
  - 主题运行时存储：[store.js](../src/features/themes/store.js:1)
  - 主题包辅助（规范化/校验/序列化）：[pack.js](../src/features/themes/pack.js:1)
  - 令牌定义（基础默认值）：[tokens.css](../src/styles/tokens.css:1)
  - 主题契约（稳定选择器与令牌清单）：[contract.json](../public/themes/contract.json:1)
  - 入口加载（首屏引入令牌与初始化主题）：[main.js](../src/main.js:1)
  - UI 导入入口（外观面板-主题页签）：[AppearancePanel.vue](../src/components/sidebar/AppearancePanel.vue:1)
  - 主题消费示例（对话预览响应变量钩子）：[ThreadedChatPreview.vue](../src/components/chat/ThreadedChatPreview.vue:1)

### 1. 主题包结构（Theme Pack v1）

主题包为单个 JSON（或以 .sttheme.json 扩展名），推荐结构：
```json
{
  "id": "my-theme-id",
  "name": "My Theme",
  "version": "1.0.0",
  "tokens": {
    "--st-primary": "56 189 248",
    "--st-accent": "168 85 247",
    "--st-card-radius": "12px",
    "--st-content-line-height": 1.7
  },
  "css": "/* 可选：附加 CSS，内部可直接使用上面的 tokens */"
  /* "script": { "code": "...", "permissions": { "dom": false, "network": false }, "scopes": ["chat-threaded"] }  // 保留字段，默认不执行 */
}
```

规则与建议：
- tokens 必须是 CSS 自定义属性名（以 -- 开头）。值支持字符串或数字（建议字符串，如 "12px"、"56 189 248"）。
- css 可选，用于追加全局样式（运行时以 &lt;style id="st-theme-css"&gt; 注入），建议仅通过 [contract.json](../public/themes/contract.json:1) 中列出的 data-scope / data-part 选择器定向覆盖。
- script 字段保留但默认不执行（安全优先）。未来若开启，将通过沙盒桥接限制能力，详见“安全与沙盒”章节。

### 2. 稳定选择器契约与令牌清单

- 稳定选择器契约（stable scopes/parts）：参见 [contract.json](../public/themes/contract.json:1)
  - scopeAttr: data-scope，partAttr: data-part
  - 示例：
    - [data-scope="chat-threaded"]、[data-scope="message-item"]、[data-part="content"] 等
  - 不要依赖 DOM 深度或内部类名；优先使用契约定义的选择器。

- 令牌（Design Tokens）基线定义：参见 [tokens.css](../src/styles/tokens.css:1)
  - 包含颜色、半径、阴影、字体验证、页面背景图钩子，聊天调优（字号、行距、间距、卡片圆角、色条宽度）、沙盒/舞台尺寸与比例、不透明度控制等。
  - 主题与外观面板会通过 document.documentElement.style.setProperty 动态覆盖。

令牌应用优先级（后覆盖前）：
1) 基线 tokens（[tokens.css](../src/styles/tokens.css:1)）
2) 主题包 tokens + CSS（[manager.js](../src/features/themes/manager.js:1) / [store.js](../src/features/themes/store.js:1) 注入）
3) 外观面板（[AppearancePanel.vue](../src/components/sidebar/AppearancePanel.vue:1)）即时调优（localStorage 持久化）

### 3. 主题导入与应用

方式 A：在 UI 中导入
- 打开“外观”面板 -> “主题”页签 -> “导入主题包”
- 选择 .json / .sttheme.json 文件。应用后会自动持久化（localStorage），刷新仍保持。
- “重置为默认主题”可清除主题注入与持久化。

方式 B：通过 URL 参数加载（便于开发/分享）
- themeUrl：?themeUrl=/themes/my.json（支持相对/绝对 URL）
- themeData：?themeData=&lt;base64(JSON文本)&gt;（更便于单链接分享）
- themePersist：?themePersist=0/1（默认 1：开启持久化；0：仅本次会话）

运行时细节：
- 入口在挂载前初始化主题运行时（减少首屏闪烁），参见 [main.js](../src/main.js:1)。
- 主题状态与事件由 [store.js](../src/features/themes/store.js:1) 管理，外部可监听 'change' / 'theme-applied' / 'theme-reset'。

### 4. 安全与沙盒（预留）

- 当前版本默认不执行主题脚本（script.allowScript=false）。
- 未来若开启脚本：
  - 必须运行于受限 iframe（CSP + sandbox），通过消息桥接（postMessage）与宿主交互。
  - 参考保留的沙盒骨架：
    - Host（宿主桥）：[host.js](../src/features/themes/sandbox/host.js:1)
    - Client（iframe 内桥）：[client.js](../src/features/themes/sandbox/client.js:1)
  - 权限 gating（permissions.dom / permissions.network）与作用域（scopes）将做显式校验并最小授权。

### 5. 主题最佳实践

- 覆盖样式时避免全局元素选择器，优先以契约 data-scope / data-part 精准选择。
- 尽量使用 tokens 进行主题化，让 UI 自适应；仅在确实需要时编写附加 CSS。
- 若需要替换图片/字体资源，推荐将链接写入 tokens（例如背景）或将资源作为绝对/相对 URL；避免内联过大的 base64 以减小体积。
- 注意暗色主题兼容性：优先覆盖 tokens（如 --st-overlay-ink、--st-color-bg/--st-color-text 等）。

### 6. 示例：最小主题

```json
{
  "id": "st-demo",
  "name": "ST Demo",
  "version": "1.0.0",
  "tokens": {
    "--st-primary": "129 140 248",
    "--st-accent": "94 234 212",
    "--st-card-radius": "14px",
    "--st-content-line-height": 1.8,
    "--st-message-gap": "14px",
    "--st-stripe-width": "10px"
  },
  "css": "[data-scope='message-item']{border-color:rgba(var(--st-primary),0.35)}"
}
```

导入后效果：
- 主/强调色更新；消息卡圆角/间距/行距/色条宽度随 tokens 变化。
- 组件样式通过变量响应，无需修改组件逻辑，参见 [ThreadedChatPreview.vue](../src/components/chat/ThreadedChatPreview.vue:1)。

---
附注：
- 运行配置（允许脚本开关、契约 URL、持久化键位等）见 [public/config.json](../public/config.json:1)。
- 若主题需要自定义页面背景图，可覆盖 --st-bg-start / --st-bg-threaded / --st-bg-sandbox 或在外观面板-背景页签上传（浏览器本地持久化）。