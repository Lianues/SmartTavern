# PromptEditor 前端开发文档（架构与项目结构）

本文档规划 PromptEditor 的项目结构与架构原则，确保组件与业务解耦、可扩展、可维护。首期聚焦“预设”视图与三栏布局。

## 技术栈与约束
- Vue 3 + Vite + TypeScript
- 路由：vue-router@4；状态：Pinia
- 样式：Tailwind（CDN），字体：Google Fonts（Inter），图标：Lucide（CDN）
- 颜色仅黑白与灰阶；4/8pt 间距；圆角 4px；响应式设计
- 端口注入由 modularflow_config.py 的 DEV_COMMAND 控制

## 目录结构
src/
  app/                 应用外壳与全局挂载（AppShell、布局容器等）
  layouts/             布局组件（三栏）
  components/          通用无业务组件（按钮、卡片、分割面板等）
  features/            业务功能模块（按域划分，如 presets、worldbook 等）
  views/               路由视图（每个功能的页面入口，仅组合 feature 组件）
  router/              路由定义与守卫
  store/               Pinia 仓库（按域拆分）
  services/            后端通信与适配层（API 客户端、DTO、Mapper）
  composables/         复用逻辑（useXxx）
  types/               全局类型定义（TS 接口/枚举）
  utils/               工具函数（纯函数，不依赖 UI）
  assets/              静态资源（不使用图片时可为空）
  style.css            全局样式（保持轻量，优先使用 Tailwind 类）

## 解耦原则
- 视图不直接调用后端；视图只组合组件与调用 store/composable
- 组件保持“无副作用”，不直接 request；副作用放 services/composables
- store 管理状态与业务事件，内部调用 services
- services 负责 HTTP 与数据映射，返回干净的模型类型
- types 提供所有模型/枚举；避免硬编码字符串
- features 目录中，每个功能模块自包含：组件、store、services、types（局部）
- 路由懒加载，避免首屏负担；按需代码分割

## 路由规划
- 名称与路径：
  - 预设 presets => /presets
  - 世界书 worldbook => /worldbook
  - 角色卡 characters => /characters
  - 正则 regex => /regex
  - 用户信息 user => /user
  - 对话历史 history => /history
- 默认重定向：/ => /presets
- 中间视图由 <router-view> 渲染；右侧栏为全局组件

## 状态规划（Pinia）
- uiStore：布局状态（侧栏折叠、当前选中项等）
- presetStore：预设数据（setting、regex_rules、prompts 等），支持加载/保存/校验
- promptStore：全局提示词树（供右侧预览）；当前阶段为占位
- userStore：用户信息
- historyStore：对话历史

## 类型定义（简化示例）
export interface PresetSetting {
  temperature: number;
  frequency_penalty: number;
  presence_penalty: number;
  top_p: number;
  top_k: number;
  max_context: number;
  max_tokens: number;
  stream: boolean;
}
export interface RegexRule {
  id: string;
  name: string;
  enabled: boolean;
  find_regex: string;
  replace_regex: string;
  targets: ('user' | 'assistant')[];
  placement: 'after_macro' | 'before_macro' | 'postprocess';
  views: string[];
}
export interface PromptItem {
  identifier: string;
  name: string;
  enabled: boolean | null;
  role: 'user' | 'system' | 'assistant';
  position: 'relative' | 'in-chat';
  depth?: number;
  order?: number;
  content?: string;
}
export interface PresetData {
  setting: PresetSetting;
  regex_rules: RegexRule[];
  prompts: PromptItem[];
}

## 服务层设计（services）
- apiClient.ts：统一封装 fetch/axios；基础地址与前缀默认 http://localhost:8050 + /api
- SmartTavernService.ts：读取与写入 SmartTavern 相关数据（如 presets）
- mapper.ts：DTO ↔ 模型映射，确保 TS 类型安全
- 错误处理：统一捕获并向 store 返回结构化错误

## 组件设计
- Sidebar（左侧导航）：纯展示 + 触发路由；不持久存储
- SplitPane（三栏布局）：左/中/右分割，支持拖拽宽度（后续）
- Form 控件：输入、滑块、开关、代码区（content）
- GlobalPromptPreview（右侧）：第一阶段仅占位；未来从 promptStore 渲染

## “预设”视图初版
- 结构：
  - 顶部卡片：预设说明与操作（保存、重置）
  - 左侧设置表单：PresetSetting 字段
  - 右侧列表：prompts 条目（可编辑 name/role/position/content）
  - 底部：regex_rules 简表编辑（启用/规则/替换/目标）
- 交互：
  - 保存：调用 presetStore.save() → services.SmartTavern.savePreset()
  - 重置：presetStore.resetToDefault()
  - 表单均为受控组件，使用 v-model 与 TS 类型约束

## 样式与规范
- Tailwind 功能类优先；全局样式只放关键覆盖，并使用 !important
- 颜色仅黑白与灰阶；遵循 60-30-10 原则
- 间距严格 4/8/16/24/32px；点击区域 ≥48×48px
- 微交互：轻阴影、平移 1px、过渡 ≤ 200ms

## 扩展策略
- 每个功能模块在 src/features 下建立文件夹：
  - presets/（视图+组件+store+services+types）
  - worldbook/
  - characters/
  - regex/
  - user/
  - history/
- 路由按模块懒加载：import() 动态引入视图
- store 与 services 按模块命名隔离；禁止跨模块直接 import impl

## 编码规范
- TS 严格模式；枚举与字面量类型优先
- 统一命名：kebab-case 文件，PascalCase 组件，camelCase 变量/函数
- Barrel（index.ts）按需导出，避免循环依赖
- 绝不在组件内直接写 fetch；统一走 services

## 后续计划（迭代）
- 第 1 阶段：接入 CDN 与布局骨架 + 预设视图表单与列表
- 第 2 阶段：右侧全局预览（基于 promptStore 计算）
- 第 3 阶段：其余视图与后端读写联通
- 第 4 阶段：交互增强（拖拽分栏、快捷键、校验提示）